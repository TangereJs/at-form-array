<link rel="import" href="../at-theme/at-theme.html">
<link rel="import" href="../at-core-form/schema-helpers-import.html">
<link rel="import" href="../at-rule-engine/at-rule-engine.html">
<link rel="import" href="../at-form-complex/at-form-complex.html">

<dom-module id="at-form-array">
  <template>
    <style include="at-form-common"></style>
    <style>
      :host * {
        box-sizing: border-box;
      }

      :host {
        @apply(--at-form-host);
      }

      .header-warpper-inner {
        @apply(--layout-horizontal);
      }

      #headerWrapper .header-padding {
        width: 110px;
      }

      .header-text {
        font-weight: 500;
        margin: 0 2px;
      }

      .action-button {
        margin: 2px;
        padding: 2px;
      }

      .item-container .item-actions-container {
        width: 110px;
      }

      #hint {
        min-height: 14px;
        margin-bottom: 8px;
      }

    </style>
    <div id="atContainer" class="at-container">
      <label id="label">{{label}}</label>
      <div class="contentContainer" class="at-content-container">
        <div id="schemaAssigned" class="hidden">
          <div id="headerWrapper">
            <div class="header-warpper-inner">
              <div id="headerContainer" class="horizontal layout center flex">
              </div>
              <div id="headerPadding" class="header-padding"></div>
            </div>
          </div>
          <div id="itemsContainer" class="items-container vertical layout"></div>
          <div>
            <button id="addItemBtn" type="button">Add item</button>
          </div>
        </div>
        <div id="schemaNotAssigned">Schema not assigned.</div>
      </div>
      <div id="hint"></div>
    </div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-form-array',
      properties: {
        label: {
          type: String,
          value: ''
        },
        hideLabel: {
          type: Boolean,
          value: false,
          observer: 'hideLabelChanged'
        },
        disabled: {
          type: Boolean,
          value: false,
          observer: 'disabledChanged'
        },
        required: {
          type: Boolean,
          value: false,
          observer: 'requiredChanged'
        },
        valid: {
          type: Boolean,
          value: true,
          notify: true,
          readOnly: true
        },
        errorMessage: {
          type: String,
          value: '',
          observer: 'errorMessageChanged'
        },
        value: {
          type: Array,
          value: function() {
            return [];
          },
          observer: 'valueChanged'
        },
        schema: {
          type: Object,
          value: function() {
            return {
              items: {
                properties: {
                  value: {
                    type: "string",
                    title: "Value"
                  }
                }
              }
            };
          },
          observer: 'schemaChanged',
          xtype: 'json'
        },
        layout: {
          type: String,
          value: 'horizontal',
          observer: 'layoutChanged',
          xtype: 'enum',
          xvaluelist: 'vertical,horizontal'
        },
        /**
         * Hides the element. When hidden nothing is displayed for the element
         * @property hide
         * @type Boolean
         * @default false
         */
        hide: {
          type: Boolean,
          value: false,
          observer: 'hideChanged'
        }
      },
      $meta: [{
        type: 'array',
        title: 'Array'
      }],
      // ------------------------------------------------------------
      // unsupported types
      // list type or xtype of the element that should not be supported by at-form-array
      // ------------------------------------------------------------
      _unsupported_types: ["object", "array"],
      set valid(newValue) {},
      hideChanged: function(newValue, oldValue) {
        var container = this.$.atContainer;
        this.toggleClass('hidden', newValue, container);
        this._updateValidState();
      },
      ready: function() {
        var self = this;
        this.$.addItemBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          self._addNewItem();
        });
        this.toggleClass('hidden', this.layout === 'vertical', this.$.headerWrapper);
        this._isReady = true;
      },
      disabledChanged: function(newValue, oldValue) {
        var atContainer = this.$.atContainer;
        this.toggleClass('disabled', newValue, atContainer);

        var afNodeList = Polymer.dom(this.root).querySelectorAll('at-form-complex');
        var i, node;
        var buttons = Polymer.dom(this.root).querySelectorAll('button');
        var button;

        if (newValue) {
          for (i = 0; i < afNodeList.length; i++) {
            node = afNodeList[i];
            node.disabled = true;
          }

          for (i = 0; i < buttons.length; i++) {
            button = buttons[i];
            button.setAttribute('disabled', true);
          }

        } else {
          for (i = 0; i < afNodeList.length; i++) {
            node = afNodeList[i];
            node.disabled = false;
          }

          for (i = 0; i < buttons.length; i++) {
            button = buttons[i];
            button.removeAttribute('disabled');
          }
        }
        this._updateValidState();
      },
      requiredChanged: function(newValue, oldValue) {
        this._updateValidState();
      },
      _updateValidState: function() {
        if (!this._isReady) {
          return;
        }

        var valid = this._validateSelf();

        var formComplexElements = this.getElementsByTagName('at-form-complex');
        var fceLen = formComplexElements.length;
        for (var i = 0; i < fceLen && valid; i++) {
          var formComplex = formComplexElements[i];
          var complexValid = formComplex.valid;
          valid = valid && complexValid;
        }

        this._setValid(valid);
      },
      _validateSelf: function () {
        var valid = this.hide || this.disabled;
        var isExternalValid = this.errorMessage == null || this.errorMessage === "";
        if (!valid) {
          valid = !this.required || (this.required && this.value.length > 0);
        }

        valid = this.hide || this.disabled || (valid && isExternalValid);

        var hint = this.$.hint;
        if (hint) {
          if (this.hide || this.disabled) {
            Polymer.dom(hint).innerHTML = '';
          } else if (!isExternalValid) {
            Polymer.dom(hint).innerHTML = this.errorMessage;
          } else if (!valid) {
            Polymer.dom(hint).innerHTML = 'At least one item is required';
          } else {
            Polymer.dom(hint).innerHTML = '';
          }
        }

        // update valid UI
        var label = this.$.label;
        this.toggleClass('error', !valid, label);
        // hint = this.$.hint;
        this.toggleClass('error', !valid, hint);
        return valid;
      },
      validate: function () {
        if (!this._isReady) {
          return;
        }

        var valid = this._validateSelf();

        var formComplexElements = this.getElementsByTagName('at-form-complex');
        var fceLen = formComplexElements.length;
        for (var i = 0; i < fceLen; i++) {
          var formComplex = formComplexElements[i];
          var complexValid = formComplex.validate();
          valid = valid && complexValid;
        }

        this._setValid(valid);

        return valid;
      },
      /// QUICK FIX remove when at-form-array gets validation behavior
      clearUIValidState: function() {

      },
      errorMessageChanged: function (newValue, oldValue) {
        this._updateValidState();
      },
      focus: function() {
        var addItemBtn = this.$.addItemBtn;
        addItemBtn.focus();
      },
      hideLabelChanged: function(newValue, oldValue) {
        this.toggleClass("hidden", newValue, this.$.label);
      },
      layoutChanged: function(newValue, oldValue) {
        var itemsContainer, itemContainers, items, self = this;

        this.toggleClass('hidden', newValue === 'vertical', this.$.headerWrapper);

        itemsContainer = Polymer.dom(this.$.itemsContainer);
        itemContainers = itemsContainer.querySelectorAll('.item-container');
        items = itemsContainer.querySelectorAll('.item');
        var itemActionsContainers = Polymer.dom(itemsContainer).querySelectorAll('.item-actions-container');

        if (newValue === 'horizontal') {
          itemContainers.forEach(function(itemContainer) {
            self.toggleClass('horizontal', true, itemContainer);
            self.toggleClass('vertical', false, itemContainer);
          });
          items.forEach(function(item) {
            self.toggleClass('horizontal', true, item);
            self.toggleClass('vertical', false, item);
            item._layout = 'horizontal';
            item.hideLabelsForElements();
          });
          // itemActionsContainers.forEach(function(itemActionsContainer, index) {
            // itemActionsContainer.style['align-self'] = 'center';
          // });
        } else if (newValue === 'vertical') {
          itemContainers.forEach(function(itemContainer) {
            self.toggleClass('horizontal', false, itemContainer);
            self.toggleClass('vertical', true, itemContainer);
          });
          items.forEach(function(item) {
            self.toggleClass('horizontal', false, item);
            self.toggleClass('vertical', true, item);
            item._layout = 'vertical';
            item.showLabelsForElements();
          });
          // itemActionsContainers.forEach(function(itemActionsContainer, index) {
            // itemActionsContainer.style['align-self'] = 'flex-start';
          // });
        } else {
          console.log('Layout value + ' + newValue + ' is unsupported. Supported values are horizontal and vertical.');
          console.log('at-form-array layout not changed.');
        }
      },
      valueChanged: function(newValue, oldValue) {
        if (!this.schema) {
          return;
        }
        var properties = this._getSchemaProperties(this.schema);

        if (properties) {
          this._updateItemsContainerHtml();
          this._updateValidState();
        } else {
          console.log('Can not update value when schema is not assigned');
          return;
        }
      },
      schemaChanged: function(newValue, oldValue) {
        if (Object.prototype.toString.call(newValue) === "[object String]") {
          try {
            newValue = JSON.parse(newValue);
            this.schema = newValue;
            return;
          } catch (e) {
            console.log(e);
          }
        }

        if (!newValue) {
          return;
        }

        var properties = this._getSchemaProperties(newValue);

        if (properties) {
          Polymer.dom(this.$.schemaNotAssigned).classList.add('hidden');
          Polymer.dom(this.$.schemaAssigned).classList.remove('hidden');

          this._updateHeader();
        }
      },
      _addNewItem: function() {
        var newEntry = this._createNewItemValueEntry(this.schema.items.properties);
        this.value.push(newEntry);
        var position = this.value.length - 1;

        var newItemHtml = this._createNewItemContainerHtml(newEntry, position);
        Polymer.dom(this.$.itemsContainer).appendChild(newItemHtml);

        var formComplex = Polymer.dom(newItemHtml).querySelector("at-form-complex");
        if (formComplex) {
          formComplex.focus();
        }

        // update buttons for previous element
        var itemContainer = Polymer.dom(newItemHtml).previousSibling;
        if (itemContainer) {
          this._updateItemActionButtons(itemContainer, position-1, position + 1);
        }

        this._fireValueChangedEvent();
      },
      _removeItem: function(position) {
        var removedEntry = this.value.splice(position, 1);

        // remove html for the removed entry
        var itemsContainer = this.$.itemsContainer;
        var itemContainers = Polymer.dom(itemsContainer).querySelectorAll('.item-container');
        var itemContainerAtPosition = itemContainers[position];
        Polymer.dom(itemsContainer).removeChild(itemContainerAtPosition);
        Polymer.dom.flush();

        // update positions for the remaining entries
        var valueLength = this.value.length;
        itemContainers = Polymer.dom(itemsContainer).querySelectorAll('.item-container');
        for (var i = position; i < valueLength; i += 1) {
          var itemContainer = itemContainers[i];
          var formComplex = Polymer.dom(itemContainer).querySelector('at-form-complex');
          if (formComplex) {
            Polymer.dom(formComplex).setAttribute('data-position', i);
          }
          // update buttons
          this._updateItemActionButtons(itemContainer, i, valueLength);
        }
        if (position > 0 && position === valueLength) {
          // update data attribute for the last element
          itemContainer = itemContainers[position - 1];
          formComplex = Polymer.dom(itemContainer).querySelector('at-form-complex');
          if (formComplex) {
            Polymer.dom(formComplex).setAttribute('data-position', position - 1);
          }
          // update buttons for last element
          this._updateItemActionButtons(itemContainer, position-1, valueLength);
        }

        this._fireValueChangedEvent();
      },
      _moveItemUp: function(position) {
        var prev = position - 1;
        var tmp;
        var valueLength = this.value.length;
        tmp = this.value[position];
        this.value[position] = this.value[prev];
        this.value[prev] = tmp;

        // replace item html positions
        var itemsContainer = this.$.itemsContainer;
        var itemContainers = Polymer.dom(itemsContainer).querySelectorAll('.item-container');
        var itemHtmlAtPosition = itemContainers[position];
        var itemHtmlAtPrev = itemContainers[prev];

        Polymer.dom(itemsContainer).removeChild(itemHtmlAtPosition);
        Polymer.dom(itemsContainer).insertBefore(itemHtmlAtPosition, itemHtmlAtPrev);

        // replace position attributes
        var formComplex = Polymer.dom(itemHtmlAtPosition).querySelector('at-form-complex');
        if (formComplex) {
          Polymer.dom(formComplex).setAttribute('data-position', prev);
        }
        formComplex = Polymer.dom(itemHtmlAtPrev).querySelector('at-form-complex');
        if (formComplex) {
          Polymer.dom(formComplex).setAttribute('data-position', position);
        }

        // update action buttons
        this._updateItemActionButtons(itemHtmlAtPosition, prev, valueLength);
        this._updateItemActionButtons(itemHtmlAtPrev, position, valueLength);

        this._fireValueChangedEvent();
      },
      _moveItemDown: function(position) {
        var next = position + 1;
        var tmp;
        var valueLength = this.value.length;
        tmp = this.value[position];
        this.value[position] = this.value[next];
        this.value[next] = tmp;

        // replace item html positions
        var itemsContainer = this.$.itemsContainer;
        var itemContainers = Polymer.dom(itemsContainer).querySelectorAll('.item-container');
        var itemHtmlAtPosition = itemContainers[position];
        var itemHtmlAtNext = itemContainers[next];

        Polymer.dom(itemsContainer).removeChild(itemHtmlAtNext);
        Polymer.dom(itemsContainer).insertBefore(itemHtmlAtNext, itemHtmlAtPosition);

        // replace position attributes
        var formComplex = Polymer.dom(itemHtmlAtPosition).querySelector('at-form-complex');
        if (formComplex) {
          Polymer.dom(formComplex).setAttribute('data-position', next);
        }
        formComplex = Polymer.dom(itemHtmlAtNext).querySelector('at-form-complex');
        if (formComplex) {
          Polymer.dom(formComplex).setAttribute('data-position', position);
        }

        // update action buttons
        this._updateItemActionButtons(itemHtmlAtPosition, next, valueLength);
        this._updateItemActionButtons(itemHtmlAtNext, position, valueLength);

        this._fireValueChangedEvent();
      },
      _getPosition: function(button) {
        var positionAttr = button.getAttribute('data-position');
        if (positionAttr) {
          return parseInt(positionAttr);
        }
        // this code should never be executed; if its executed there is an error in html
        console.error('Button doesn\'t have position attribute');
        return -1;
      },
      _updateHeader: function() {
        var keyCount;
        var properties;
        var flexValue;
        var flexClass;
        var propDef
        var headerText;
        var headerItem;
        var spanText;
        var self = this;

        properties = this._getSchemaProperties(this.schema);

        if (properties) {
          // clear current header
          Polymer.dom(this.$.headerContainer).innerHTML = '';

          keyCount = Object.keys(properties).length;
          flexValue = 12 / keyCount;
          flexClass = 'flex-' + flexValue;

          Object.keys(properties).forEach(function(propertyName, index) {
            propDef = properties[propertyName];
            headerText = propDef.title ? propDef.title : propertyName;
            headerItem = document.createElement('div');
            Polymer.dom(headerItem).classList.add(flexClass);
            Polymer.dom(self.$.headerContainer).appendChild(headerItem);

            spanText = document.createElement('span');
            Polymer.dom(spanText).classList.add('header-text');
            Polymer.dom(spanText).innerHTML = headerText;
            Polymer.dom(headerItem).appendChild(spanText);
          });
        } else {
          console.log("Invalid schema structure. Missing schema.items and / or schema.items.properties property");
          console.log("Schema: ", JSON.stringify(this.schema, undefined, ' '));
        }
      },
      _updateItemsContainerHtml: function() {
        var
          existingItemHtmlArr,
          valueArrIndex,
          item,
          existingItemHtml,
          newItemHtml;

        // query items container for existing html
        existingItemHtmlArr = Polymer.dom(this.$.itemsContainer).querySelectorAll('.item-container');

        // for each entry in this.value array
        for (valueArrIndex = 0; valueArrIndex < this.value.length; valueArrIndex += 1) {
          item = this.value[valueArrIndex];
          existingItemHtml = existingItemHtmlArr[valueArrIndex];

          if (existingItemHtml) {
            // update existing html if available
            this._updateItemContainerHtml(existingItemHtml, item, valueArrIndex);
          } else {
            // create new html "item-container" if needed
            newItemHtml = this._createNewItemContainerHtml(item, valueArrIndex);
            Polymer.dom(this.$.itemsContainer).appendChild(newItemHtml);
          }
        }

        // remove exceeding html
        while (valueArrIndex < existingItemHtmlArr.length) {
          existingItemHtml = existingItemHtmlArr[valueArrIndex];
          existingItemHtml.remove();
          valueArrIndex += 1;
        }
      },
      _createNewItemContainerHtml: function(item, position) {
        var self = this;
        var itemDiv = document.createElement('div');
        Polymer.dom(itemDiv).classList.add('item-container');
        Polymer.dom(itemDiv).classList.add(self.layout);
        Polymer.dom(itemDiv).classList.add('layout');

        var properties = this._getSchemaProperties(this.schema);
        if (!properties) {
          return;
        }
        var itemHtml = this._createItemHtmlFromSchema(properties, item, position);
        Polymer.dom(itemDiv).appendChild(itemHtml);

        var itemActionsDiv = document.createElement('div');
        Polymer.dom(itemActionsDiv).classList.add('item-actions-container');
        // Polymer.dom(itemActionsDiv).classList.add('flex-2');
        Polymer.dom(itemDiv).appendChild(itemActionsDiv);

        // ------------------------------
        // create move up button
        // ------------------------------
        var moveUpBtn = document.createElement('button');
        Polymer.dom(moveUpBtn).setAttribute('type', 'button');
        Polymer.dom(moveUpBtn).classList.add('action-button');
        if (position === 0) {
          Polymer.dom(moveUpBtn).classList.add('hidden');
        }
        Polymer.dom(moveUpBtn).setAttribute('data-action-type', 'moveup');
        Polymer.dom(moveUpBtn).setAttribute('data-position', position);
        Polymer.dom(moveUpBtn).setAttribute('title', 'Move Up');
        moveUpBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          var position = self._getPosition(event.currentTarget);
          self._moveItemUp(position);
        });
        Polymer.dom(itemActionsDiv).appendChild(moveUpBtn);
        var moveUpIcon = document.createElement('at-carbon-icon');
        moveUpIcon.icon = "now:arrow-up";
        Polymer.dom(moveUpBtn).appendChild(moveUpIcon);

        // ------------------------------
        // create move down button
        // ------------------------------
        var moveDownBtn = document.createElement('button');
        Polymer.dom(moveDownBtn).setAttribute('type', 'button');
        Polymer.dom(moveDownBtn).classList.add('action-button');
        if (position === this.value.length - 1) {
          moveDownBtn.classList.add('hidden');
        }
        Polymer.dom(moveDownBtn).setAttribute('data-action-type', 'movedown');
        Polymer.dom(moveDownBtn).setAttribute('data-position', position);
        Polymer.dom(moveDownBtn).setAttribute('title', 'Move Down');
        moveDownBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          var position = self._getPosition(event.currentTarget);
          self._moveItemDown(position);
        });
        Polymer.dom(itemActionsDiv).appendChild(moveDownBtn);
        var moveDownIcon = document.createElement('at-carbon-icon');
        moveDownIcon.icon = 'now:arrow-down';
        Polymer.dom(moveDownBtn).appendChild(moveDownIcon);

        // ------------------------------
        // create remove button
        // ------------------------------
        var removeBtn = document.createElement('button');
        Polymer.dom(removeBtn).setAttribute('type', 'button');
        Polymer.dom(removeBtn).classList.add('action-button');
        Polymer.dom(removeBtn).setAttribute('data-action-type', 'remove');
        Polymer.dom(removeBtn).setAttribute('data-position', position);
        Polymer.dom(removeBtn).setAttribute('title', 'Remove');
        removeBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          var position = self._getPosition(event.currentTarget);
          self._removeItem(position);
        });
        Polymer.dom(itemActionsDiv).appendChild(removeBtn);
        var removeIcon = document.createElement('at-carbon-icon');
        removeIcon.icon = "now:delete";
        Polymer.dom(removeBtn).appendChild(removeIcon);

        return itemDiv;
      },
      _createItemHtmlFromSchema: function(properties, item, position) {
        var self = this;
        var resultHtml = document.createElement('at-form-complex');
        resultHtml._layout = self.layout;
        var rules = [];
        if (self.schema.rules) {
          rules = this.schema.rules;
        }
        resultHtml.schema = {
          properties: properties,
          rules: rules
        };
        var assignValue = {};
        this._cloneObject(Object.keys(item), item, assignValue);
        resultHtml.value = assignValue;
        resultHtml.clearUIValidState();
        Polymer.dom(resultHtml).setAttribute('data-position', position);
        Polymer.dom(resultHtml).classList.add('item');
        Polymer.dom(resultHtml).classList.add(self.layout);
        Polymer.dom(resultHtml).classList.add('layout');
        Polymer.dom(resultHtml).classList.add('flex');
        resultHtml._layout = self.layout;

        resultHtml.addEventListener('value-changed', function(event) {
          var _resultHtml = resultHtml;
          event.stopPropagation();
          var position = parseInt(_resultHtml.getAttribute('data-position'));
          var value = event.detail.value;
          // this is here to filter value-changed event from at-form-complex individual elements
          // for unknown reasons we get value-changed twice here, once for at-form-complex.value-changed and another one for at-form-complex.individualElement.value-changed
          if (event.srcElement.is === "at-form-complex") {
            self._updateValue(position, value);
          }
        });

        return resultHtml;
      },
      _updateItemContainerHtml: function(existingItemHtml, item, position) {
        var itemHtml = Polymer.dom(existingItemHtml).querySelector('.item');
        this._updateItemHtml(itemHtml, item, position);
        this._updateItemActionButtons(existingItemHtml, position, this.value.length);
      },
      _updateItemHtml: function(existingItemHtml, item, position) {
        var prevValue = existingItemHtml.value;
        existingItemHtml.value = item;
        // existingItemHtml.valueChanged(item, prevValue);
        Polymer.dom(existingItemHtml).setAttribute('data-position', position);
      },
      _updateItemActionButtons: function(existingItemHtml, position, maxItems) {
        var actionButotns;
        var actionButtonsIndex;
        var actionButton;
        var moveUpBtn;
        var moveDownBtn;

        actionButotns = Polymer.dom(existingItemHtml).querySelectorAll('.action-button');
        for (actionButtonsIndex = 0; actionButtonsIndex < actionButotns.length; actionButtonsIndex += 1) {
          actionButton = actionButotns[actionButtonsIndex];
          Polymer.dom(actionButton).setAttribute('data-position', position);
        }

        moveUpBtn = Polymer.dom(existingItemHtml).querySelector('[data-action-type="moveup"]');
        moveDownBtn = Polymer.dom(existingItemHtml).querySelector('[data-action-type="movedown"]');
        if (position === 0) {
          Polymer.dom(moveUpBtn).classList.add('hidden');
          if (maxItems > 1) {
            Polymer.dom(moveDownBtn).classList.remove('hidden');
          }
        }
        if (position > 0 && position < maxItems - 1) {
          Polymer.dom(moveUpBtn).classList.remove('hidden');
          Polymer.dom(moveDownBtn).classList.remove('hidden');
        }
        if (position === maxItems-1) {
          Polymer.dom(moveDownBtn).classList.add('hidden');
          if (maxItems === 2) {
            Polymer.dom(moveUpBtn).classList.remove('hidden');
          }
        }
      },
      _createNewItemValueEntry: function(properties) {
        var result = {};

        for (var propName in properties) {
          var propDef = properties[propName];
          var propType = propDef.type;

          if (propType === "string" && propDef.enum) {
            propType = "enum";
          }

          if (propType === "boolean") {
            result[propName] = false;
          } else if (propType === "enum") {
            if (propDef.default) {
              result[propName] = propDef.default;
            } else {
              result[propName] = "";
            }
          } else {
            result[propName] = "";
          }
        }

        return result;
      },
      _setItemPropertyState: function(position, property, state, value) {
        // 1. get element by position and property name
        var element = this._getElementFromForm(position);
        if (element) {
          // 2. set element's state
          element.setElementState(property, state, value);
        }
      },
      updateFormElementValue: function(position, value) {
        // 1. get element by position and property name
        var element = this._getElementFromForm(position);
        if (element) {
          element.value = value;
        }
      },
      _getElementFromForm: function(position) {
        var query = ".item" + "[data-position=\"" + position + "\"]";
        var element = Polymer.dom(this.$.itemsContainer).querySelector(query);
        return element;
      },
      _updateValue: function(position, value) {
        this.value[position] = value;
        this._fireValueChangedEvent();
      },
      _cloneArrayValue: function(originalArray) {
        var clonedArray = [];
        var i;
        var oLen = originalArray.length;
        for (i = 0; i < oLen; i++) {
          var cItem = {};
          var oItem = originalArray[i];
          var propNames = Object.keys(oItem);
          this._cloneObject(propNames, oItem, cItem);
          clonedArray.push(cItem);
        }
        return clonedArray;
      },
      _cloneObject: function(propertyNames, source, destination) {
        propertyNames.forEach(function(property, index) {
          destination[property] = source[property];
        });
      },
      _removeItemValueEntry: function(position) {
        this.splice('value', position, 1);
        this._fireValueChangedEvent();
      },
      _fireValueChangedEvent: function() {
        this._updateValidState();

        this.fire('value-changed', {
          value: this.value
        });
      },
      // *ij* since array.schema can be either { items: { properties: {} } } or { schema: { items: { properties: {} } }, rules: [] }
      // this helper function gets the propertis for both cases
      // if schema is string its converted to object
      // if an error occurs an undefined is returned as result
      _getSchemaProperties: function(schema) {
        var result = undefined;
        if (this._isString(schema)) {
          try {
            schema = JSON.parse(schema);
          } catch (e) {
            console.log(e);
            return result;
          }
        }

        if (schema.items && schema.items.properties) {
          result = schema.items.properties;
        }

        return result;
      },
      _isString: function(obj) {
        return Object.prototype.toString.call(obj) === "[object String]";
      }
    });
  </script>
</dom-module>
<!--
<div class="item-container">
  <at-form-input></at-form-input>
  <div class="item-actions-container">
    <button class="action-button" data-action-type="Remove" data-position="0">Remove</button>
    <button class="action-button" data-action-type="MoveUp" data-position="0">Move Up</button>
    <button class="action-button" data-action-type="MoveDown" data-position="0">Move Down</button>
  </div>
</div>
-->
