<link rel="import" href="../layout/layout.html">
<link rel="import" href="../at-core-form/schema-helpers-import.html">

<dom-module id="at-form-array">
  <style>
    .item-action-hidden {
      display: none;
    }

    .hidden-div {
      display: none;
    }

    .hide-label {
      display: none;
    }

    #headerWrapper.hide-header {
      display: none;
    }

    .field-wrapper {
      margin: 2px;
      padding: 2px;
    }

    .action-button {
      margin: 2px;
      padding: 2px;
    }

    .headerText {
      font-weight: bold;
      margin: 0 2px;
      padding: 0 2px;
    }

    .label-content {}
  </style>
  <template>
    <at-core-theme></at-core-theme>
    <div class="field vertical layout">
      <div id="labelContainer">
        <h4 class="label-content">{{label}}</h4>
      </div>
      <div id="schemaAssigned" class="hidden-div">
        <div id="headerWrapper" class="horizontal layout">
          <div id="headerContainer" class="horizontal layout center flex-10">
          </div>
          <div id="headerPadding" class="flex-2"></div>
        </div>
        <div id="itemsContainer" class="items-container vertical layout"></div>
        <div>
          <button id="addItemBtn" type="button">Add item</button>
        </div>
      </div>
      <div id="schemaNotAssigned">
        <p>Schema not assigned.</p>
      </div>
    </div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-form-array',
      properties: {
        label: {
          type: String,
          value: ''
        },
        hideTitle: {
          type: Boolean,
          value: false,
          observer: 'hideTitleChanged'
        },
        disabled: {
          type: Boolean,
          value: false,
          observer: 'disabledChanged'
        },
        required: {
          type: Boolean,
          value: false
        },
        value: {
          type: Array,
          value: function() {
            return [];
          },
          observer: 'valueChanged'
        },
        schema: {
          type: Object,
          value: function() {
            return {};
          },
          observer: 'schemaChanged'
        },
        layout: {
          type: String,
          value: 'vertical',
          observer: 'layoutChanged'
        }
      },
      _scopeCssViaAttr: true,
      _unsupported_types: ["object"],
      ready: function() {
        var self = this;
        this.$.addItemBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          self._addNewItem();
        });
        this.toggleClass('hide-header', this.layout === 'vertical', this.$.headerWrapper);
      },
      disabledChanged: function(newValue, oldValue) {
        /* ij - to easily and quickly select all elements that need to be disabled
          each at-form-* element is assigned data-tagname attribute with value of elements tag name
          ie. at-form-input element would have data-tagname="at-form-input" set
          now all at-form-* elements can be selected with [data-tagname^="at-form-"] selector
        */
        var afNodeList = Polymer.dom(this.root).querySelectorAll('[data-tagname^="at-form-"]'),
          i, node,
          buttons = Polymer.dom(this.root).querySelectorAll('button'),
          button;

        if (newValue) {
          for (i = 0; i < afNodeList.length; i++) {
            node = afNodeList[i];
            node.disabled = true;
          }

          for (i = 0; i < buttons.length; i++) {
            button = buttons[i];
            button.setAttribute('disabled', true);
          }

        } else {
          for (i = 0; i < afNodeList.length; i++) {
            node = afNodeList[i];
            node.disabled = false;
          }

          for (i = 0; i < buttons.length; i++) {
            button = buttons[i];
            button.removeAttribute('disabled');
          }
        }
      },
      hideTitleChanged: function(newValue, oldValue) {
        this.toggleClass("hide-label", newValue, this.$.labelContainer);
      },
      layoutChanged: function(newValue, oldValue) {
        var itemsContainer, itemContainers, items, fieldWrappers, self = this;;

        this.toggleClass('hide-header', newValue === 'vertical', this.$.headerWrapper);

        itemsContainer = Polymer.dom(this.$.itemsContainer);
        itemContainers = itemsContainer.querySelectorAll('.item-container');
        items = itemsContainer.querySelectorAll('.item');
        fieldWrappers = itemsContainer.querySelectorAll('.field-wrapper');

        if (newValue === 'horizontal') {
          itemContainers.forEach(function(itemContainer) {
            self.toggleClass('horizontal', true, itemContainer);
            self.toggleClass('vertical', false, itemContainer);
          });
          items.forEach(function(item) {
            self.toggleClass('horizontal', true, item);
            self.toggleClass('vertical', false, item);
          });
          fieldWrappers.forEach(function(wrapper) {
            Polymer.dom(wrapper).firstChild.hideTitle = true;
          });
        } else if (newValue === 'vertical') {
          itemContainers.forEach(function(itemContainer) {
            self.toggleClass('horizontal', false, itemContainer);
            self.toggleClass('vertical', true, itemContainer);
          });
          items.forEach(function(item) {
            self.toggleClass('horizontal', false, item);
            self.toggleClass('vertical', true, item);
          });
          fieldWrappers.forEach(function(wrapper) {
            Polymer.dom(wrapper).firstChild.hideTitle = false;
          });
        } else {
          console.log('Layout value + ' + newValue + ' is unsupported. Supported values are horizontal and vertical.');
          console.log('at-form-array layout not changed.');
        }
      },
      valueChanged: function(newValue, oldValue) {
        if (this.schema && this.schema.items && this.schema.items.properties) {
          this._updateItemsContainerHtml();
        } else {
          console.log('Can not update value when schema is not assigned');
          return;
        }
      },
      schemaChanged: function(newValue, oldValue) {
        if (newValue && newValue.items && newValue.items.properties) {
          Polymer.dom(this.$.schemaNotAssigned).classList.add('hidden-div');
          Polymer.dom(this.$.schemaAssigned).classList.remove('hidden-div');

          this._updateHeader();
        }
      },
      _addNewItem: function () {
          var newEntry = this._createNewItemValueEntry(this.schema.items.properties);
          this.value.push(newEntry);
          this._updateItemsContainerHtml();
          this._fireValueChangedEvent();

          var nameFieldList = Polymer.dom(this.$.itemsContainer).querySelectorAll(".name");
          if (nameFieldList.length > 0) {
              nameFieldList[nameFieldList.length - 1].focus();
          }
      },
      _removeItem: function(position) {
        this.value.splice(position, 1);

        for (var i = position; i < this.value.length; i += 1) {
          var item = this.value[i];
        }
        this._updateItemsContainerHtml();
        this._fireValueChangedEvent();
      },
      _moveItemUp: function(position) {
        var prev = position - 1;
        var tmp;

        tmp = this.value[position];
        this.value[position] = this.value[prev];
        this.value[prev] = tmp;

        this._updateItemsContainerHtml();
        this._fireValueChangedEvent();
      },
      _moveItemDown: function(position) {
        var next = position + 1;
        var tmp;

        tmp = this.value[position];
        this.value[position] = this.value[next];
        this.value[next] = tmp;

        this._updateItemsContainerHtml();
        this._fireValueChangedEvent();
      },
      _getPosition: function(button) {
        var positionAttr = button.getAttribute('data-position');
        if (positionAttr) {
          return parseInt(positionAttr);
        }
        // this code should never be executed; if its executed there is an error in html
        console.error('Button doesn\'t have position attribute');
        return -1;
      },
      _updateHeader: function() {
        var keyCount,
          properties,
          flexValue,
          flexClass,
          propDef,
          headerText,
          headerItem,
          spanText,
          self = this;

        // clear current header
        Polymer.dom(this.$.headerContainer).innerHTML = '';

        if (this.schema && this.schema.items && this.schema.items.properties) {
          properties = this.schema.items.properties;
          keyCount = Object.keys(properties).length;
          flexValue = 12 / keyCount;
          flexClass = 'flex-' + flexValue;

          Object.keys(properties).forEach(function(propertyName, index) {
            propDef = properties[propertyName];
            headerText = propDef.title ? propDef.title : propertyName;
            headerItem = document.createElement('div');
            Polymer.dom(headerItem).classList.add(flexClass);
            Polymer.dom(self.$.headerContainer).appendChild(headerItem);

            spanText = document.createElement('span');
            Polymer.dom(spanText).classList.add('headerText');
            Polymer.dom(spanText).innerHTML = headerText;
            Polymer.dom(headerItem).appendChild(spanText);
          });
        } else {
          console.log("Invalid schema structure. Missing schema.items and / or schema.items.properties property");
          console.log("Schema: ", JSON.stringify(this.schema, undefined, ' '));
        }
      },
      _updateItemsContainerHtml: function() {
        var
          existingItemHtmlArr,
          valueArrIndex,
          item,
          existingItemHtml,
          newItemHtml;

        // query items container for existing html
        existingItemHtmlArr = Polymer.dom(this.$.itemsContainer).querySelectorAll('.item-container');

        // for each entry in this.value array
        for (valueArrIndex = 0; valueArrIndex < this.value.length; valueArrIndex += 1) {
          item = this.value[valueArrIndex];
          existingItemHtml = existingItemHtmlArr[valueArrIndex];

          if (existingItemHtml) {
            // update existing html if available
            this._updateItemContainerHtml(existingItemHtml, item, valueArrIndex);
          } else {
            // create new html "item-container" if needed
            newItemHtml = this._createNewItemContainerHtml(item, valueArrIndex);
            Polymer.dom(this.$.itemsContainer).appendChild(newItemHtml);
          }
        }

        // remove exceeding html
        while (valueArrIndex < existingItemHtmlArr.length) {
          existingItemHtml = existingItemHtmlArr[valueArrIndex];
          existingItemHtml.remove();
          valueArrIndex += 1;
        }
      },
      _createNewItemContainerHtml: function(item, position) {
        var self = this;
        var itemDiv = document.createElement('div');
        Polymer.dom(itemDiv).classList.add('item-container');
        Polymer.dom(itemDiv).classList.add(self.layout);
        Polymer.dom(itemDiv).classList.add('layout');

        var itemHtml = this._createItemHtmlFromSchema(this.schema.items.properties, item, position);
        Polymer.dom(itemDiv).appendChild(itemHtml);

        var itemActionsDiv = document.createElement('div');
        Polymer.dom(itemActionsDiv).classList.add('item-actions-container');
        Polymer.dom(itemActionsDiv).classList.add('flex-2');
        Polymer.dom(itemDiv).appendChild(itemActionsDiv);

        // ------------------------------
        // create move up button
        // ------------------------------
        var moveUpBtn = document.createElement('button');
        Polymer.dom(moveUpBtn).setAttribute('type', 'button');
        Polymer.dom(moveUpBtn).classList.add('action-button');
        if (position === 0) {
          Polymer.dom(moveUpBtn).classList.add('item-action-hidden');
        }
        Polymer.dom(moveUpBtn).setAttribute('data-action-type', 'moveup');
        Polymer.dom(moveUpBtn).setAttribute('data-position', position);
        Polymer.dom(moveUpBtn).setAttribute('title', 'Move Up');
        moveUpBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          var position = self._getPosition(event.currentTarget);
          self._moveItemUp(position);
        });
        Polymer.dom(itemActionsDiv).appendChild(moveUpBtn);
        var moveUpIcon = document.createElement('at-carbon-icon');
        moveUpIcon.icon = "now:arrow-up";
        Polymer.dom(moveUpBtn).appendChild(moveUpIcon);

        // ------------------------------
        // create move down button
        // ------------------------------
        var moveDownBtn = document.createElement('button');
        Polymer.dom(moveDownBtn).setAttribute('type', 'button');
        Polymer.dom(moveDownBtn).classList.add('action-button');
        if (position === this.value.length - 1) {
          moveDownBtn.classList.add('item-action-hidden');
        }
        Polymer.dom(moveDownBtn).setAttribute('data-action-type', 'movedown');
        Polymer.dom(moveDownBtn).setAttribute('data-position', position);
        Polymer.dom(moveDownBtn).setAttribute('title', 'Move Down');
        moveDownBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          var position = self._getPosition(event.currentTarget);
          self._moveItemDown(position);
        });
        Polymer.dom(itemActionsDiv).appendChild(moveDownBtn);
        var moveDownIcon = document.createElement('at-carbon-icon');
        moveDownIcon.icon = 'now:arrow-down';
        Polymer.dom(moveDownBtn).appendChild(moveDownIcon);

        // ------------------------------
        // create remove button
        // ------------------------------
        var removeBtn = document.createElement('button');
        Polymer.dom(removeBtn).setAttribute('type', 'button');
        Polymer.dom(removeBtn).classList.add('action-button');
        Polymer.dom(removeBtn).setAttribute('data-action-type', 'remove');
        Polymer.dom(removeBtn).setAttribute('data-position', position);
        Polymer.dom(removeBtn).setAttribute('title', 'Remove');
        removeBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          var position = self._getPosition(event.currentTarget);
          self._removeItem(position);
        });
        Polymer.dom(itemActionsDiv).appendChild(removeBtn);
        var removeIcon = document.createElement('at-carbon-icon');
        removeIcon.icon = "now:delete";
        Polymer.dom(removeBtn).appendChild(removeIcon);

        return itemDiv;
      },
      _createItemHtmlFromSchema: function(properties, item, position) {
        var self = this,
          resultHtml = undefined,
          flexValue,
          flexClass,
          propertyKeys = Object.keys(properties),
          propsLength = propertyKeys.length;

        if (propsLength > 0) {
          resultHtml = document.createElement('div');
          Polymer.dom(resultHtml).classList.add('item');
          Polymer.dom(resultHtml).classList.add(self.layout);
          Polymer.dom(resultHtml).classList.add('layout');
          Polymer.dom(resultHtml).classList.add('flex-10');

          flexValue = 12 / propsLength;
          flexClass = 'flex-' + flexValue;
          propertyKeys.forEach(function(propName) {
            var propDef = properties[propName];
            var propType = schemaHelpers.getDisplayType(propDef, self._unsupported_types);

              var flexDiv = document.createElement('div');
              Polymer.dom(flexDiv).classList.add('field-wrapper');
              Polymer.dom(flexDiv).classList.add(flexClass);

              var htmlElem = schemaHelpers.createElement(propName, propType, propDef);
              Polymer.dom(htmlElem).classList.add('item-property');
              htmlElem.hideTitle = self.layout === 'horizontal';
              Polymer.dom(htmlElem).setAttribute('data-name', propName);
              Polymer.dom(htmlElem).setAttribute('data-tagname', htmlElem.is);
              Polymer.dom(htmlElem).setAttribute('data-position', position);

              if (item[propName]) {
                htmlElem.value = item[propName];
              } else if (propDef.default) {
                htmlElem.value = propDef.default;
              } else {
                item[propName] = htmlElem.value;
              }

              htmlElem.addEventListener('value-changed', function(event) {
                // event.stopPropagation();
                var position = self._getPosition(event.target);
                var property = event.target.getAttribute('data-name');
                var value = event.detail.value;
                self._updateItemValueEntry(position, property, value);
              });

              Polymer.dom(flexDiv).appendChild(htmlElem);
              Polymer.dom(resultHtml).appendChild(flexDiv);
          });
        }
        return resultHtml;
      },
      _updateItemContainerHtml: function(existingItemHtml, item, position) {
        var afInput, actionButotns, actionButtonsIndex, actionButton, moveUpBtn, moveDownBtn;

        var itemHtml = Polymer.dom(existingItemHtml).querySelector('.item');
        this._updateItemHtml(itemHtml, item, position);

        actionButotns = Polymer.dom(existingItemHtml).querySelectorAll('.action-button');
        for (actionButtonsIndex = 0; actionButtonsIndex < actionButotns.length; actionButtonsIndex += 1) {
          actionButton = actionButotns[actionButtonsIndex];
          Polymer.dom(actionButton).setAttribute('data-position', position);
        }

        moveUpBtn = Polymer.dom(existingItemHtml).querySelector('[data-action-type="moveup"]');
        moveDownBtn = Polymer.dom(existingItemHtml).querySelector('[data-action-type="movedown"]');
        if (position === 0) {
          Polymer.dom(moveUpBtn).classList.add('item-action-hidden');
          if (this.value.length > 1) {
            Polymer.dom(moveDownBtn).classList.remove('item-action-hidden');
          }
        }
        if (position > 0 && position < this.value.length - 1) {
          Polymer.dom(moveUpBtn).classList.remove('item-action-hidden');
          Polymer.dom(moveDownBtn).classList.remove('item-action-hidden');
        }
        if (position === this.value.length - 1) {
          Polymer.dom(moveDownBtn).classList.add('item-action-hidden');
        }
      },
      _updateItemHtml: function(existingItemHtml, item, position) {
        var properties = Polymer.dom(existingItemHtml).querySelectorAll('.item-property');
        var index, prop;
        for (index = 0; index < properties.length; index += 1) {
          prop = properties[index];
          prop.value = item[prop.getAttribute('data-name')];
          Polymer.dom(prop).setAttribute('data-position', position);
        }
      },
      _createNewItemValueEntry: function(properties) {
        var result = {};

        for (var propName in properties) {
          var propDef = properties[propName];
          var propType = propDef.type;

          if (propType === "string" && propDef.enum) {
            propType = "enum";
          }

          if (propType === "boolean") {
            result[propName] = false;
          } else if (propType === "enum") {
            if (propDef.default) {
              result[propName] = propDef.default;
            } else {
              result[propName] = "";
            }
          } else {
            result[propName] = "";
          }
        }

        return result;
      },
      _updateItemValueEntry: function(position, property, value) {
        if (this.value[position][property] !== value) {
          this.value[position][property] = value;
          this._fireValueChangedEvent();
        }
      },
      _removeItemValueEntry: function(position) {
        this.value.splice(position, 1);
        this._fireValueChangedEvent();
      },
      _fireValueChangedEvent: function() {
        this.fire('value-changed', {
          value: this.value
        });
      }
    });
  </script>
</dom-module>
<!--
<div class="item-container">
  <at-form-input></at-form-input>
  <div class="item-actions-container">
    <button class="action-button" data-action-type="Remove" data-position="0">Remove</button>
    <button class="action-button" data-action-type="MoveUp" data-position="0">Move Up</button>
    <button class="action-button" data-action-type="MoveDown" data-position="0">Move Down</button>
  </div>
</div>
-->
