<link rel="import" href="../at-core-theme/at-core-theme.html" />
<link rel="import" href="../at-form-input/at-form-input.html" />
<link rel="import" href="../at-form-lookup/at-form-lookup.html" />
<link rel="import" href="../at-form-checkbox/at-form-checkbox.html" />

<dom-module id="at-form-array">
  <style>
    .item-action-hidden {
      display: none;
    }

    .hidden-div {
      display: none;
    }
  </style>
  <template>
    <div class="field">
      <div>
        <label>{{label}}</label>
      </div>
      <div id="schemaAssigned" class="hidden-div">
        <div>
          <button id="addItemBtn">Add item</button>
        </div>
        <div id="itemsContainer" class="items-container">
        </div>
      </div>
      <div id="schemaNotAssigned">
        <p>Schema not assigned.</p>
      </div>
    </div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-form-array',
      properties: {
        label: {
          type: String,
          value: ''
        },
        disabled: {
          type: Boolean,
          value: false,
          observer: 'disabledChanged'
        },
        required: {
          type: Boolean,
          value: false
        },
        value: {
          type: Array,
          value: function() {
            return [];
          },
          observer: 'valueChanged'
        },
        schema: {
          type: Object,
          value: function() {
            return {};
          },
          observer: 'schemaChanged'
        }
      },
      _scopeCssViaAttr: true,
      ready: function() {
        var self = this;
        this.$.addItemBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          self._addNewItem();
        });
      },
      disabledChanged: function(newValue, oldValue) {
        /* ij - to easily and quickly select all elements that need to be disabled
          each at-form-* element is assigned data-tagname attribute with value of elements tag name
          ie. at-form-input element would have data-tagname="at-form-input" set
          now all at-form-* elements can be selected with [data-tagname^="at-form-"] selector
        */
        var afNodeList = Polymer.dom(this.root).querySelectorAll('[data-tagname^="at-form-"]'),
          i, node,
          buttons = Polymer.dom(this.root).querySelectorAll('button'),
          button;

        if (newValue) {
          for (i = 0; i < afNodeList.length; i++) {
            node = afNodeList[i];
            node.disabled = true;
          }

          for (i = 0; i < buttons.length; i++) {
            button = buttons[i];
            button.setAttribute('disabled', true);
          }

        } else {
          for (i = 0; i < afNodeList.length; i++) {
            node = afNodeList[i];
            node.disabled = false;
          }

          for (i = 0; i < buttons.length; i++) {
            button = buttons[i];
            button.removeAttribute('disabled');
          }
        }
      },
      valueChanged: function(newValue, oldValue) {
        this._updateItemsContainerHtml();
      },
      schemaChanged: function(newValue, oldValue) {
        if (newValue && newValue.items && newValue.items.properties) {
          this.$.schemaNotAssigned.classList.add('hidden-div');
          this.$.schemaAssigned.classList.remove('hidden-div');
        }
      },
      _addNewItem: function() {
        var newEntry = this._createNewItemValueEntry(this.schema.items.properties);
        this.value.push(newEntry);
        this._updateItemsContainerHtml();
        this._fireValueChangedEvent();
      },
      _removeItem: function(position) {
        this.value.splice(position, 1);

        for (var i = position; i < this.value.length; i += 1) {
          var item = this.value[i];
        }
        this._updateItemsContainerHtml();
        this._fireValueChangedEvent();
      },
      _moveItemUp: function(position) {
        var prev = position - 1;
        var tmp;

        tmp = this.value[position];
        this.value[position] = this.value[prev];
        this.value[prev] = tmp;

        this._updateItemsContainerHtml();
        this._fireValueChangedEvent();
      },
      _moveItemDown: function(position) {
        var next = position + 1;
        var tmp;

        tmp = this.value[position];
        this.value[position] = this.value[next];
        this.value[next] = tmp;

        this._updateItemsContainerHtml();
        this._fireValueChangedEvent();
      },
      _getPosition: function(button) {
        var positionAttr = button.getAttribute('data-position');
        if (positionAttr) {
          return parseInt(positionAttr);
        }
        // this code should never be executed; if its executed there is an error in html
        console.error('Button doesn\'t have position attribute');
        return -1;
      },
      _updateItemsContainerHtml: function() {
        var
          existingItemHtmlArr,
          valueArrIndex,
          item,
          existingItemHtml,
          newItemHtml;

        // query items container for existing html
        existingItemHtmlArr = this.$.itemsContainer.querySelectorAll('.item-container');

        // for each entry in this.value array
        for (valueArrIndex = 0; valueArrIndex < this.value.length; valueArrIndex += 1) {
          item = this.value[valueArrIndex];
          existingItemHtml = existingItemHtmlArr[valueArrIndex];

          if (existingItemHtml) {
            // update existing html if available
            this._updateItemContainerHtml(existingItemHtml, item, valueArrIndex);
          } else {
            // create new html "item-container" if needed
            newItemHtml = this._createNewItemContainerHtml(item, valueArrIndex);
            Polymer.dom(this.$.itemsContainer).appendChild(newItemHtml);
          }
        }

        // remove exceeding html
        while (valueArrIndex < existingItemHtmlArr.length) {
          existingItemHtml = existingItemHtmlArr[valueArrIndex];
          existingItemHtml.remove();
          valueArrIndex += 1;
        }
      },
      _createNewItemContainerHtml: function(item, position) {
        var self = this;
        var itemDiv = document.createElement('div');
        itemDiv.setAttribute('style-scope', 'at-form-array');
        itemDiv.classList.add('item-container');

        var itemHtml = this._createItemHtmlFromSchema(this.schema.items.properties, item, position);
        Polymer.dom(itemDiv).appendChild(itemHtml);

        var itemActionsDiv = document.createElement('div');
        itemActionsDiv.setAttribute('style-scope', 'at-form-array');
        itemActionsDiv.classList.add('item-actions-container');
        Polymer.dom(itemDiv).appendChild(itemActionsDiv);

        var removeBtn = document.createElement('button');
        removeBtn.setAttribute('style-scope', 'at-form-array');
        removeBtn.classList.add('action-button');
        removeBtn.setAttribute('data-action-type', 'remove');
        removeBtn.setAttribute('data-position', position);
        removeBtn.innerHTML = 'Remove';
        removeBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          var position = self._getPosition(event.target);
          self._removeItem(position);
        });
        Polymer.dom(itemActionsDiv).appendChild(removeBtn);

        var moveUpBtn = document.createElement('button');
        moveUpBtn.setAttribute('style-scope', 'at-form-array');
        moveUpBtn.classList.add('action-button');
        if (position === 0) {
          moveUpBtn.classList.add('item-action-hidden');
        }
        moveUpBtn.setAttribute('data-action-type', 'moveup');
        moveUpBtn.setAttribute('data-position', position);
        moveUpBtn.innerHTML = 'Move Up';
        moveUpBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          var position = self._getPosition(event.target);
          self._moveItemUp(position);
        });
        Polymer.dom(itemActionsDiv).appendChild(moveUpBtn);

        var moveDownBtn = document.createElement('button');
        moveDownBtn.setAttribute('style-scope', 'at-form-array');
        moveDownBtn.classList.add('action-button');
        if (position === this.value.length - 1) {
          moveDownBtn.classList.add('item-action-hidden');
        }
        moveDownBtn.setAttribute('data-action-type', 'movedown');
        moveDownBtn.setAttribute('data-position', position);
        moveDownBtn.innerHTML = 'Move Down';
        moveDownBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          var position = self._getPosition(event.target);
          self._moveItemDown(position);
        });
        Polymer.dom(itemActionsDiv).appendChild(moveDownBtn);

        return itemDiv;
      },
      _createItemHtmlFromSchema: function(properties, item, position) {
        var self = this;
        var resultHtml = undefined;
        if (Object.keys(properties).length > 0) {
          resultHtml = document.createElement('div');
          resultHtml.classList.add('item');

          for (var propName in properties) {
            var propDef = properties[propName];
            var propType = propDef.type;

            if (propType === "string" && propDef.enum) {
              propType = "enum";
            }

            var htmlElem = undefined;

            switch (propType) {
              case "string":
                htmlElem = document.createElement('at-form-input');
                htmlElem.value = item[propName];
                htmlElem.setAttribute('data-tagname', 'at-form-input');
                break;
              case "enum":
                htmlElem = document.createElement('at-form-lookup');
                htmlElem.available = propDef.enum.join(",");
                htmlElem.setAttribute('data-tagname', 'at-form-lookup');
                if (item[propName]) {
                  htmlElem.value = item[propName];
                } else if (propDef.default) {
                  htmlElem.value = propDef.default;
                }
                break;
              case "boolean":
                htmlElem = document.createElement('at-form-checkbox');
                htmlElem.setAttribute('data-tagname', 'at-form-checkbox');
                htmlElem.value = item[propName];
                break;
            }

            htmlElem.setAttribute('style-scope', 'at-form-array');
            htmlElem.setAttribute('data-position', position);
            htmlElem.setAttribute('data-name', propName);
            htmlElem.classList.add('item-property');
            if (propDef.title) {
              htmlElem.label = propDef.title;
            } else {
              htmlElem.label = propName;
            }
            Polymer.dom(resultHtml).appendChild(htmlElem);
            htmlElem.addEventListener('value-changed', function(event) {
              event.stopPropagation();
              var position = self._getPosition(event.target);
              var property = event.target.getAttribute('data-name');
              var value = event.detail.value;
              self._updateItemValueEntry(position, property, value);
            });
          }
        }
        return resultHtml;
      },
      _updateItemContainerHtml: function(existingItemHtml, item, position) {
        var afInput, actionButotns, actionButtonsIndex, actionButton, moveUpBtn, moveDownBtn;

        var itemHtml = existingItemHtml.querySelector('.item');
        this._updateItemHtml(itemHtml, item, position);

        actionButotns = existingItemHtml.querySelectorAll('.action-button');
        for (actionButtonsIndex = 0; actionButtonsIndex < actionButotns.length; actionButtonsIndex += 1) {
          actionButton = actionButotns[actionButtonsIndex];
          actionButton.setAttribute('data-position', position);
        }

        moveUpBtn = existingItemHtml.querySelector('[data-action-type="moveup"]');
        moveDownBtn = existingItemHtml.querySelector('[data-action-type="movedown"]');
        if (position === 0) {
          moveUpBtn.classList.add('item-action-hidden');
          if (this.value.length > 1) {
            moveDownBtn.classList.remove('item-action-hidden');
          }
        }
        if (position > 0 && position < this.value.length - 1) {
          moveUpBtn.classList.remove('item-action-hidden');
          moveDownBtn.classList.remove('item-action-hidden');
        }
        if (position === this.value.length - 1) {
          moveDownBtn.classList.add('item-action-hidden');
        }
      },
      _updateItemHtml: function(existingItemHtml, item, position) {
        var properties = existingItemHtml.querySelectorAll('.item-property');
        var index, prop;
        for (index = 0; index < properties.length; index += 1) {
          prop = properties[index];
          prop.value = item[prop.getAttribute('data-name')];
          prop.setAttribute('data-position', position);
        }
      },
      _createNewItemValueEntry: function(properties) {
        var result = {};

        for (var propName in properties) {
          var propDef = properties[propName];
          var propType = propDef.type;

          if (propType === "string" && propDef.enum) {
            propType = "enum";
          }

          if (propType === "boolean") {
            result[propName] = false;
          } else if (propType === "enum") {
            if (propDef.default) {
              result[propName] = propDef.default;
            } else {
              result[propName] = "";
            }
          } else {
            result[propName] = "";
          }
        }

        return result;
      },
      _updateItemValueEntry: function(position, property, value) {
        if (this.value[position][property] !== value) {
          this.value[position][property] = value;
          this._fireValueChangedEvent();
        }
      },
      _removeItemValueEntry: function(position) {
        this.value.splice(position, 1);
        this._fireValueChangedEvent();
      },
      _fireValueChangedEvent: function() {
        this.fire('value-changed', {
          value: this.value
        });
      }
    });
  </script>
</dom-module>
<!--
<div class="item-container">
  <at-form-input></at-form-input>
  <div class="item-actions-container">
    <button class="action-button" data-action-type="Remove" data-position="0">Remove</button>
    <button class="action-button" data-action-type="MoveUp" data-position="0">Move Up</button>
    <button class="action-button" data-action-type="MoveDown" data-position="0">Move Down</button>
  </div>
</div>
-->
