<!doctype html>
<html>

<head>

  <title>at-form-array tests</title>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>

  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/test-helpers.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>

  <link rel="import" href="../at-form-array.html">

</head>

<body>

  <test-fixture>
    <template>
      <at-form-array></at-form-array>
    </template>
  </test-fixture>

  <script>
    suite('tests for schema and data where schema and data are set as properties', function() {

      suite('schema is invalid, data is invalid', function() {

        test('invalid schema, invalid data both provided as arrays of invalid values', function() {
          var invalidSchemas = [ undefined, null, "", "undefined", true, false, 424242, 3.14159, {}, [] ];
          var invalidDatas = [undefined, null, "", true, false, 424242, 3.14159, {} ];

          var formArray = document.createElement('at-form-array');
          var insertPoint = formArray.$.itemsContainer;

          for (var i = 0; i < invalidSchemas.length; i++) {
            var schema = invalidSchemas[i];
            for (var j = 0; j < invalidDatas.length; j++) {
              var data = invalidDatas[j];

              formArray.schema = schema;
              formArray.value = data;

              assert.equal(schemaHelpers.areEqual(formArray.schema, schema), true, "schema not set correctly");
              assert.equal(schemaHelpers.areEqual(formArray.value, data), true, "value not set correctly");
              assert.equal(Polymer.dom(insertPoint).children.length, 0, 'itemsContainer is not empty');
            }
          }
        });

        test('invalid schema, invalid data both provided as arrays of invalid string values', function() {
          var invalidSchemas = [ "null", "true", "false", "424242", "3.14159", "{}", "[]" ];
          var invalidDatas = [ "null", "true", "false", "424242", "3.14159", "{}" ];

          var formArray = document.createElement('at-form-array');
          var insertPoint = formArray.$.itemsContainer;

          for (var i = 0; i < invalidSchemas.length; i++) {
            var schema = invalidSchemas[i];
            for (var j = 0; j < invalidDatas.length; j++) {
              var data = invalidDatas[j];

              formArray.schema = schema;
              formArray.value = data;

              assert.equal(schemaHelpers.areEqual(formArray.schema, JSON.parse(schema)), true, "schema not set correctly");
              assert.equal(schemaHelpers.areEqual(formArray.value, JSON.parse(data)), true, "value not set correctly");
              assert.equal(Polymer.dom(insertPoint).children.length, 0, 'itemsContainer is not empty');
            }
          }

          formArray.schema = function() { return undefined; };
          formArray.value = function() { return undefined; };

          assert.equal(schemaHelpers.isFunction(formArray.schema), true, "schema not set correctly");
          assert.equal(schemaHelpers.isFunction(formArray.value), true, "value not set correctly");
          assert.equal(Polymer.dom(insertPoint).children.length, 0, 'itemsContainer is not empty');

        });

      });

      suite('schema is invalid, value is valid', function() {

        function getValue() {
          return [{}, {}, {}];
        }

        test('invalid schema, invalid data both provided as arrays of invalid values', function() {
          var invalidSchemas = [ undefined, null, "", "undefined", true, false, 424242, 3.14159, {}, [] ];

          var formArray = document.createElement('at-form-array');
          var insertPoint = formArray.$.itemsContainer;

          for (var i = 0; i < invalidSchemas.length; i++) {
            var schema = invalidSchemas[i];

            formArray.schema = schema;
            formArray.value = getValue();

            assert.equal(schemaHelpers.areEqual(formArray.schema, schema), true, "schema not set correctly");
            assert.equal(schemaHelpers.areEqual(formArray.value, getValue()), true, "value not set correctly");
            assert.equal(Polymer.dom(insertPoint).children.length, 0, 'itemsContainer is not empty');
          }
        });

        test('invalid schema, invalid data both provided as arrays of invalid string values', function() {
          var invalidSchemas = [ "null", "true", "false", "424242", "3.14159", "{}", "[]" ];

          var formArray = document.createElement('at-form-array');
          var insertPoint = formArray.$.itemsContainer;

          for (var i = 0; i < invalidSchemas.length; i++) {
            var schema = invalidSchemas[i];

            formArray.schema = schema;
            formArray.value = getValue();

            assert.equal(schemaHelpers.areEqual(formArray.schema, JSON.parse(schema)), true, "schema not set correctly");
            assert.equal(schemaHelpers.areEqual(formArray.value, getValue()), true, "value not set correctly");
            assert.equal(Polymer.dom(insertPoint).children.length, 0, 'itemsContainer is not empty');
          }

          formArray.schema = function() { return undefined; };
          formArray.value = getValue();

          assert.equal(schemaHelpers.isFunction(formArray.schema), true, "schema not set correctly");
          assert.equal(schemaHelpers.areEqual(formArray.value, getValue()), true, "value not set correctly");
          assert.equal(Polymer.dom(insertPoint).children.length, 0, 'itemsContainer is not empty');

        });

      });

      suite('schema is valid, data is invalid', function() {

        function getSchema() {
          return {
            items: {
              properties: {
                text1: {
                  type: "string"
                },
                text2: {
                  type: "string"
                },
                text1: {
                  type: "string"
                }
              }
            }
          }
        }

        function getSchemaRules() {
          return {
            schema: {
              items: {
                properties: {
                  text1: {
                    type: "string"
                  },
                  text2: {
                    type: "string"
                  },
                  text1: {
                    type: "string"
                  }
                }
              }
            },
            rules: []
          }
        }

        test('valid schema, invalid data provided as arrays of invalid values', function() {
          var invalidDatas = [undefined, null, "", true, false, 424242, 3.14159, {} ];

          var formArray = document.createElement('at-form-array');
          var insertPoint = formArray.$.itemsContainer;

          for (var j = 0; j < invalidDatas.length; j++) {
            var data = invalidDatas[j];

            formArray.schema = getSchema();
            formArray.value = data;

            assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, "schema not set correctly");
            assert.equal(schemaHelpers.areEqual(formArray.value, data), true, "value not set correctly");
            assert.equal(Polymer.dom(insertPoint).children.length, 0, 'itemsContainer is not empty');
          }
        });

        test('valid schema, invalid data provided as arrays of invalid string values', function() {
          var invalidDatas = [ "null", "true", "false", "424242", "3.14159", "{}" ];

          var formArray = document.createElement('at-form-array');
          var insertPoint = formArray.$.itemsContainer;

          for (var j = 0; j < invalidDatas.length; j++) {
            var data = invalidDatas[j];

            formArray.schema = getSchema();
            formArray.value = data;

            assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, "schema not set correctly");
            assert.equal(schemaHelpers.areEqual(formArray.value, JSON.parse(data)), true, "value not set correctly");
            assert.equal(Polymer.dom(insertPoint).children.length, 0, 'itemsContainer is not empty');
          }

          formArray.schema = getSchema();
          formArray.value = function() { return undefined; };

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, "schema not set correctly");
          assert.equal(schemaHelpers.isFunction(formArray.value), true, "value not set correctly");
          assert.equal(Polymer.dom(insertPoint).children.length, 0, 'itemsContainer is not empty');
        });

        test('valid schema with rules, invalid data provided as arrays of invalid values', function() {
          var invalidDatas = [undefined, null, "", true, false, 424242, 3.14159, {} ];

          var formArray = document.createElement('at-form-array');
          var insertPoint = formArray.$.itemsContainer;

          for (var j = 0; j < invalidDatas.length; j++) {
            var data = invalidDatas[j];

            formArray.schema = getSchemaRules();
            formArray.value = data;

            assert.equal(schemaHelpers.areEqual(formArray.schema, getSchemaRules()), true, "schema not set correctly");
            assert.equal(schemaHelpers.areEqual(formArray.value, data), true, "value not set correctly");
            assert.equal(Polymer.dom(insertPoint).children.length, 0, 'itemsContainer is not empty');
          }
        });

        test('valid schema with rules, invalid data provided as arrays of invalid string values', function() {
          var invalidDatas = [ "null", "true", "false", "424242", "3.14159", "{}" ];

          var formArray = document.createElement('at-form-array');
          var insertPoint = formArray.$.itemsContainer;

          for (var j = 0; j < invalidDatas.length; j++) {
            var data = invalidDatas[j];

            formArray.schema = getSchemaRules();
            formArray.value = data;

            assert.equal(schemaHelpers.areEqual(formArray.schema, getSchemaRules()), true, "schema not set correctly");
            assert.equal(schemaHelpers.areEqual(formArray.value, JSON.parse(data)), true, "value not set correctly");
            assert.equal(Polymer.dom(insertPoint).children.length, 0, 'itemsContainer is not empty');
          }

          formArray.schema = getSchemaRules();
          formArray.value = function() { return undefined; };

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchemaRules()), true, "schema not set correctly");
          assert.equal(schemaHelpers.isFunction(formArray.value), true, "value not set correctly");
          assert.equal(Polymer.dom(insertPoint).children.length, 0, 'itemsContainer is not empty');

        });
      });

      suite('schema is valid, value is valid, schema set first, value next', function() {

        function getSchema() {
          return {
            items: {
              properties: {
                text1: {
                  type: "string"
                },
                text2: {
                  type: "string"
                },
                text3: {
                  type: "string",
                  "default": "text3 lorem ipsum"
                },
                text4: {
                  type: "string",
                  "default": "text4 lorem ipsum"
                }
              }
            }
          }
        }

        var stringSchema = JSON.stringify(getSchema());

        function getData() {
          return [
            {

            },
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "",
              text4: ""
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "text3 ipsum lorem",
              text4: "text4 ipsum lorem"
            }
          ];
        }

        var stringData = JSON.stringify(getData());

        test('schema is string, data is string', function(done) {
          var formArray = document.createElement('at-form-array');
          var itemsContainer = formArray.$.itemsContainer;

          var eventCount = 0;
          formArray.addEventListener('value-changed', function(event) {
            eventCount += 1;
          });

          formArray.schema = stringSchema;

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, []), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 0, 'items container should not have elements');

          formArray.value = stringData;

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, getData()), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 4, 'items container should not have elements');

          var expectedValues = [
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "",
              text4: ""
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "text3 ipsum lorem",
              text4: "text4 ipsum lorem"
            }
          ];

          for (var i = 0; i < formArray.value.length; i++) {
            var formComplex = formArray._getElementFromForm(i);
            var expectedValue = expectedValues[i];

            // internalData must have entries for each element
            assert.isObject(formComplex._internalData, 'internal data is not set');
            assert.equal(Object.keys(formComplex._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
            assert.equal(formComplex._internalData.text1, expectedValue.text1, 'text1 value not correct in _internalData');
            assert.equal(formComplex._internalData.text2, expectedValue.text2, 'text2 value not correct in _internalData');
            assert.equal(formComplex._internalData.text3, expectedValue.text3, 'text3 value not correct in _internalData');
            assert.equal(formComplex._internalData.text4, expectedValue.text4, 'text4 value not correct in _internalData');

            assert.equal(formComplex.value.text1, expectedValue.text1, 'text1 value not correct in data');
            assert.equal(formComplex.value.text2, expectedValue.text2, 'text2 value not correct in data');
            assert.equal(formComplex.value.text3, expectedValue.text3, 'text3 value not correct in data');
            assert.equal(formComplex.value.text4, expectedValue.text4, 'text4 value not correct in data');

            assert.isArray(formComplex._elementsToValidate, 'elements to validate is not set');
            assert.equal(formComplex._elementsToValidate.length, 4, 'elements to validate doesn\'t contain corrent number of elements');
            // _elementsToValidate must have entries for each element
            assert.equal(formComplex._elementsToValidate[0].id, "text1", 'text1 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[1].id, "text2", 'text2 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[2].id, "text3", 'text3 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[3].id, "text4", 'text4 not present in _elementsToValidate');

            var insertPoint = formComplex.$.insertPoint;
            assert.equal(Polymer.dom(insertPoint).children.length, 5, 'insert point doesn\'t contain corrent number of elements');
          }

          flush(function() {
            assert.equal(eventCount, 1, 'at-form-array didn\'t fire corrent number of events');
            done();
          });
        });

        test('schema is string, data is object', function(done) {
          var formArray = document.createElement('at-form-array');
          var itemsContainer = formArray.$.itemsContainer;

          var eventCount = 0;
          formArray.addEventListener('value-changed', function(event) {
            eventCount += 1;
          });

          formArray.schema = stringSchema;

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, []), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 0, 'items container should not have elements');

          formArray.value = getData();

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, getData()), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 4, 'items container should not have elements');

          var expectedValues = [
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "",
              text4: ""
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "text3 ipsum lorem",
              text4: "text4 ipsum lorem"
            }
          ];

          for (var i = 0; i < formArray.value.length; i++) {
            var formComplex = formArray._getElementFromForm(i);
            var expectedValue = expectedValues[i];

            // internalData must have entries for each element
            assert.isObject(formComplex._internalData, 'internal data is not set');
            assert.equal(Object.keys(formComplex._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
            assert.equal(formComplex._internalData.text1, expectedValue.text1, 'text1 value not correct in _internalData');
            assert.equal(formComplex._internalData.text2, expectedValue.text2, 'text2 value not correct in _internalData');
            assert.equal(formComplex._internalData.text3, expectedValue.text3, 'text3 value not correct in _internalData');
            assert.equal(formComplex._internalData.text4, expectedValue.text4, 'text4 value not correct in _internalData');

            assert.equal(formComplex.value.text1, expectedValue.text1, 'text1 value not correct in data');
            assert.equal(formComplex.value.text2, expectedValue.text2, 'text2 value not correct in data');
            assert.equal(formComplex.value.text3, expectedValue.text3, 'text3 value not correct in data');
            assert.equal(formComplex.value.text4, expectedValue.text4, 'text4 value not correct in data');

            assert.isArray(formComplex._elementsToValidate, 'elements to validate is not set');
            assert.equal(formComplex._elementsToValidate.length, 4, 'elements to validate doesn\'t contain corrent number of elements');
            // _elementsToValidate must have entries for each element
            assert.equal(formComplex._elementsToValidate[0].id, "text1", 'text1 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[1].id, "text2", 'text2 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[2].id, "text3", 'text3 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[3].id, "text4", 'text4 not present in _elementsToValidate');

            var insertPoint = formComplex.$.insertPoint;
            assert.equal(Polymer.dom(insertPoint).children.length, 5, 'insert point doesn\'t contain corrent number of elements');
          }

          flush(function() {
            assert.equal(eventCount, 1, 'at-form-array didn\'t fire corrent number of events');
            done();
          });
        });

        test('schema is object, data is string', function(done) {
          var formArray = document.createElement('at-form-array');
          var itemsContainer = formArray.$.itemsContainer;

          var eventCount = 0;
          formArray.addEventListener('value-changed', function(event) {
            eventCount += 1;
          });

          formArray.schema = getSchema();

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, []), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 0, 'items container should not have elements');

          formArray.value = stringData;

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, getData()), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 4, 'items container should not have elements');

          var expectedValues = [
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "",
              text4: ""
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "text3 ipsum lorem",
              text4: "text4 ipsum lorem"
            }
          ];

          for (var i = 0; i < formArray.value.length; i++) {
            var formComplex = formArray._getElementFromForm(i);
            var expectedValue = expectedValues[i];

            // internalData must have entries for each element
            assert.isObject(formComplex._internalData, 'internal data is not set');
            assert.equal(Object.keys(formComplex._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
            assert.equal(formComplex._internalData.text1, expectedValue.text1, 'text1 value not correct in _internalData');
            assert.equal(formComplex._internalData.text2, expectedValue.text2, 'text2 value not correct in _internalData');
            assert.equal(formComplex._internalData.text3, expectedValue.text3, 'text3 value not correct in _internalData');
            assert.equal(formComplex._internalData.text4, expectedValue.text4, 'text4 value not correct in _internalData');

            assert.equal(formComplex.value.text1, expectedValue.text1, 'text1 value not correct in data');
            assert.equal(formComplex.value.text2, expectedValue.text2, 'text2 value not correct in data');
            assert.equal(formComplex.value.text3, expectedValue.text3, 'text3 value not correct in data');
            assert.equal(formComplex.value.text4, expectedValue.text4, 'text4 value not correct in data');

            assert.isArray(formComplex._elementsToValidate, 'elements to validate is not set');
            assert.equal(formComplex._elementsToValidate.length, 4, 'elements to validate doesn\'t contain corrent number of elements');
            // _elementsToValidate must have entries for each element
            assert.equal(formComplex._elementsToValidate[0].id, "text1", 'text1 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[1].id, "text2", 'text2 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[2].id, "text3", 'text3 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[3].id, "text4", 'text4 not present in _elementsToValidate');

            var insertPoint = formComplex.$.insertPoint;
            assert.equal(Polymer.dom(insertPoint).children.length, 5, 'insert point doesn\'t contain corrent number of elements');
          }

          flush(function() {
            assert.equal(eventCount, 1, 'at-form-array didn\'t fire corrent number of events');
            done();
          });
        });

        test('schema is object, data is object', function(done) {
          var formArray = document.createElement('at-form-array');
          var itemsContainer = formArray.$.itemsContainer;

          var eventCount = 0;
          formArray.addEventListener('value-changed', function(event) {
            eventCount += 1;
          });

          formArray.schema = getSchema();

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, []), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 0, 'items container should not have elements');

          formArray.value = getData();

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, getData()), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 4, 'items container should not have elements');

          var expectedValues = [
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "",
              text4: ""
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "text3 ipsum lorem",
              text4: "text4 ipsum lorem"
            }
          ];

          for (var i = 0; i < formArray.value.length; i++) {
            var formComplex = formArray._getElementFromForm(i);
            var expectedValue = expectedValues[i];

            // internalData must have entries for each element
            assert.isObject(formComplex._internalData, 'internal data is not set');
            assert.equal(Object.keys(formComplex._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
            assert.equal(formComplex._internalData.text1, expectedValue.text1, 'text1 value not correct in _internalData');
            assert.equal(formComplex._internalData.text2, expectedValue.text2, 'text2 value not correct in _internalData');
            assert.equal(formComplex._internalData.text3, expectedValue.text3, 'text3 value not correct in _internalData');
            assert.equal(formComplex._internalData.text4, expectedValue.text4, 'text4 value not correct in _internalData');

            assert.equal(formComplex.value.text1, expectedValue.text1, 'text1 value not correct in data');
            assert.equal(formComplex.value.text2, expectedValue.text2, 'text2 value not correct in data');
            assert.equal(formComplex.value.text3, expectedValue.text3, 'text3 value not correct in data');
            assert.equal(formComplex.value.text4, expectedValue.text4, 'text4 value not correct in data');

            assert.isArray(formComplex._elementsToValidate, 'elements to validate is not set');
            assert.equal(formComplex._elementsToValidate.length, 4, 'elements to validate doesn\'t contain corrent number of elements');
            // _elementsToValidate must have entries for each element
            assert.equal(formComplex._elementsToValidate[0].id, "text1", 'text1 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[1].id, "text2", 'text2 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[2].id, "text3", 'text3 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[3].id, "text4", 'text4 not present in _elementsToValidate');

            var insertPoint = formComplex.$.insertPoint;
            assert.equal(Polymer.dom(insertPoint).children.length, 5, 'insert point doesn\'t contain corrent number of elements');
          }

          flush(function() {
            assert.equal(eventCount, 1, 'at-form-array didn\'t fire corrent number of events');
            done();
          });
        });

      });

      suite('schema is valid, data is valid, data first schema second', function() {

        function getSchema() {
          return {
            items: {
              properties: {
                text1: {
                  type: "string"
                },
                text2: {
                  type: "string"
                },
                text3: {
                  type: "string",
                  "default": "text3 lorem ipsum"
                },
                text4: {
                  type: "string",
                  "default": "text4 lorem ipsum"
                }
              }
            }
          }
        }

        var stringSchema = JSON.stringify(getSchema());

        function getData() {
          return [
            {

            },
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "",
              text4: ""
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "text3 ipsum lorem",
              text4: "text4 ipsum lorem"
            }
          ];
        }

        var stringData = JSON.stringify(getData());

        test('schema is string, value is string', function(done) {
          var formArray = document.createElement('at-form-array');
          var itemsContainer = formArray.$.itemsContainer;

          var eventCount = 0;
          formArray.addEventListener('value-changed', function(event) {
            eventCount += 1;
          });

          formArray.value = stringData;

          var initialSchema = formArray.properties.schema.value();
          assert.equal(schemaHelpers.areEqual(formArray.schema, initialSchema), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, getData()), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 4, 'items container should not have elements');

          formArray.schema = stringSchema;

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, getData()), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 4, 'items container should not have elements');

          var expectedValues = [
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "",
              text4: ""
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "text3 ipsum lorem",
              text4: "text4 ipsum lorem"
            }
          ];

          for (var i = 0; i < formArray.value.length; i++) {
            var formComplex = formArray._getElementFromForm(i);
            var expectedValue = expectedValues[i];

            // internalData must have entries for each element
            assert.isObject(formComplex._internalData, 'internal data is not set');
            assert.equal(Object.keys(formComplex._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
            assert.equal(formComplex._internalData.text1, expectedValue.text1, 'text1 value not correct in _internalData');
            assert.equal(formComplex._internalData.text2, expectedValue.text2, 'text2 value not correct in _internalData');
            assert.equal(formComplex._internalData.text3, expectedValue.text3, 'text3 value not correct in _internalData');
            assert.equal(formComplex._internalData.text4, expectedValue.text4, 'text4 value not correct in _internalData');

            assert.equal(formComplex.value.text1, expectedValue.text1, 'text1 value not correct in data');
            assert.equal(formComplex.value.text2, expectedValue.text2, 'text2 value not correct in data');
            assert.equal(formComplex.value.text3, expectedValue.text3, 'text3 value not correct in data');
            assert.equal(formComplex.value.text4, expectedValue.text4, 'text4 value not correct in data');

            assert.isArray(formComplex._elementsToValidate, 'elements to validate is not set');
            assert.equal(formComplex._elementsToValidate.length, 4, 'elements to validate doesn\'t contain corrent number of elements');
            // _elementsToValidate must have entries for each element
            assert.equal(formComplex._elementsToValidate[0].id, "text1", 'text1 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[1].id, "text2", 'text2 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[2].id, "text3", 'text3 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[3].id, "text4", 'text4 not present in _elementsToValidate');

            var insertPoint = formComplex.$.insertPoint;
            assert.equal(Polymer.dom(insertPoint).children.length, 5, 'insert point doesn\'t contain corrent number of elements');
          }

          flush(function() {
            assert.equal(eventCount, 1, 'at-form-array didn\'t fire corrent number of events');
            done();
          });
        });

        test('schema is string, data is object', function(done) {
          var formArray = document.createElement('at-form-array');
          var itemsContainer = formArray.$.itemsContainer;

          var eventCount = 0;
          formArray.addEventListener('value-changed', function(event) {
            eventCount += 1;
          });

          formArray.value = getData();

          var initialSchema = formArray.properties.schema.value();
          assert.equal(schemaHelpers.areEqual(formArray.schema, initialSchema), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, getData()), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 4, 'items container should not have elements');

          formArray.schema = stringSchema;

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, getData()), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 4, 'items container should not have elements');

          var expectedValues = [
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "",
              text4: ""
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "text3 ipsum lorem",
              text4: "text4 ipsum lorem"
            }
          ];

          for (var i = 0; i < formArray.value.length; i++) {
            var formComplex = formArray._getElementFromForm(i);
            var expectedValue = expectedValues[i];

            // internalData must have entries for each element
            assert.isObject(formComplex._internalData, 'internal data is not set');
            assert.equal(Object.keys(formComplex._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
            assert.equal(formComplex._internalData.text1, expectedValue.text1, 'text1 value not correct in _internalData');
            assert.equal(formComplex._internalData.text2, expectedValue.text2, 'text2 value not correct in _internalData');
            assert.equal(formComplex._internalData.text3, expectedValue.text3, 'text3 value not correct in _internalData');
            assert.equal(formComplex._internalData.text4, expectedValue.text4, 'text4 value not correct in _internalData');

            assert.equal(formComplex.value.text1, expectedValue.text1, 'text1 value not correct in data');
            assert.equal(formComplex.value.text2, expectedValue.text2, 'text2 value not correct in data');
            assert.equal(formComplex.value.text3, expectedValue.text3, 'text3 value not correct in data');
            assert.equal(formComplex.value.text4, expectedValue.text4, 'text4 value not correct in data');

            assert.isArray(formComplex._elementsToValidate, 'elements to validate is not set');
            assert.equal(formComplex._elementsToValidate.length, 4, 'elements to validate doesn\'t contain corrent number of elements');
            // _elementsToValidate must have entries for each element
            assert.equal(formComplex._elementsToValidate[0].id, "text1", 'text1 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[1].id, "text2", 'text2 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[2].id, "text3", 'text3 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[3].id, "text4", 'text4 not present in _elementsToValidate');

            var insertPoint = formComplex.$.insertPoint;
            assert.equal(Polymer.dom(insertPoint).children.length, 5, 'insert point doesn\'t contain corrent number of elements');
          }

          flush(function() {
            assert.equal(eventCount, 1, 'at-form-array didn\'t fire corrent number of events');
            done();
          });
        });

        test('schema is object, data is string', function(done) {
          var formArray = document.createElement('at-form-array');
          var itemsContainer = formArray.$.itemsContainer;

          var eventCount = 0;
          formArray.addEventListener('value-changed', function(event) {
            eventCount += 1;
          });

          formArray.value = stringData;

          var initialSchema = formArray.properties.schema.value();
          assert.equal(schemaHelpers.areEqual(formArray.schema, initialSchema), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, getData()), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 4, 'items container should not have elements');

          formArray.schema = getSchema();

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, getData()), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 4, 'items container should not have elements');

          var expectedValues = [
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "",
              text4: ""
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "text3 ipsum lorem",
              text4: "text4 ipsum lorem"
            }
          ];

          for (var i = 0; i < formArray.value.length; i++) {
            var formComplex = formArray._getElementFromForm(i);
            var expectedValue = expectedValues[i];

            // internalData must have entries for each element
            assert.isObject(formComplex._internalData, 'internal data is not set');
            assert.equal(Object.keys(formComplex._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
            assert.equal(formComplex._internalData.text1, expectedValue.text1, 'text1 value not correct in _internalData');
            assert.equal(formComplex._internalData.text2, expectedValue.text2, 'text2 value not correct in _internalData');
            assert.equal(formComplex._internalData.text3, expectedValue.text3, 'text3 value not correct in _internalData');
            assert.equal(formComplex._internalData.text4, expectedValue.text4, 'text4 value not correct in _internalData');

            assert.equal(formComplex.value.text1, expectedValue.text1, 'text1 value not correct in data');
            assert.equal(formComplex.value.text2, expectedValue.text2, 'text2 value not correct in data');
            assert.equal(formComplex.value.text3, expectedValue.text3, 'text3 value not correct in data');
            assert.equal(formComplex.value.text4, expectedValue.text4, 'text4 value not correct in data');

            assert.isArray(formComplex._elementsToValidate, 'elements to validate is not set');
            assert.equal(formComplex._elementsToValidate.length, 4, 'elements to validate doesn\'t contain corrent number of elements');
            // _elementsToValidate must have entries for each element
            assert.equal(formComplex._elementsToValidate[0].id, "text1", 'text1 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[1].id, "text2", 'text2 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[2].id, "text3", 'text3 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[3].id, "text4", 'text4 not present in _elementsToValidate');

            var insertPoint = formComplex.$.insertPoint;
            assert.equal(Polymer.dom(insertPoint).children.length, 5, 'insert point doesn\'t contain corrent number of elements');
          }

          flush(function() {
            assert.equal(eventCount, 1, 'at-form-array didn\'t fire corrent number of events');
            done();
          });
        });

        test('schema is object, data is object', function(done) {
          var formArray = document.createElement('at-form-array');
          var itemsContainer = formArray.$.itemsContainer;

          var eventCount = 0;
          formArray.addEventListener('value-changed', function(event) {
            eventCount += 1;
          });

          formArray.value = getData();

          var initialSchema = formArray.properties.schema.value();
          assert.equal(schemaHelpers.areEqual(formArray.schema, initialSchema), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, getData()), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 4, 'items container should not have elements');

          formArray.schema = getSchema();

          assert.equal(schemaHelpers.areEqual(formArray.schema, getSchema()), true, 'schema not set correctly');
          assert.equal(schemaHelpers.areEqual(formArray.value, getData()), true, 'value not set correctly');
          assert.equal(Polymer.dom(itemsContainer).children.length, 4, 'items container should not have elements');

          var expectedValues = [
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "",
              text2: "",
              text3: "text3 lorem ipsum",
              text4: "text4 lorem ipsum"
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "",
              text4: ""
            },
            {
              text1: "text1 lorem ipsum",
              text2: "text2 lorem ipsum",
              text3: "text3 ipsum lorem",
              text4: "text4 ipsum lorem"
            }
          ];

          for (var i = 0; i < formArray.value.length; i++) {
            var formComplex = formArray._getElementFromForm(i);
            var expectedValue = expectedValues[i];

            // internalData must have entries for each element
            assert.isObject(formComplex._internalData, 'internal data is not set');
            assert.equal(Object.keys(formComplex._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
            assert.equal(formComplex._internalData.text1, expectedValue.text1, 'text1 value not correct in _internalData');
            assert.equal(formComplex._internalData.text2, expectedValue.text2, 'text2 value not correct in _internalData');
            assert.equal(formComplex._internalData.text3, expectedValue.text3, 'text3 value not correct in _internalData');
            assert.equal(formComplex._internalData.text4, expectedValue.text4, 'text4 value not correct in _internalData');

            assert.equal(formComplex.value.text1, expectedValue.text1, 'text1 value not correct in data');
            assert.equal(formComplex.value.text2, expectedValue.text2, 'text2 value not correct in data');
            assert.equal(formComplex.value.text3, expectedValue.text3, 'text3 value not correct in data');
            assert.equal(formComplex.value.text4, expectedValue.text4, 'text4 value not correct in data');

            assert.isArray(formComplex._elementsToValidate, 'elements to validate is not set');
            assert.equal(formComplex._elementsToValidate.length, 4, 'elements to validate doesn\'t contain corrent number of elements');
            // _elementsToValidate must have entries for each element
            assert.equal(formComplex._elementsToValidate[0].id, "text1", 'text1 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[1].id, "text2", 'text2 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[2].id, "text3", 'text3 not present in _elementsToValidate');
            assert.equal(formComplex._elementsToValidate[3].id, "text4", 'text4 not present in _elementsToValidate');

            var insertPoint = formComplex.$.insertPoint;
            assert.equal(Polymer.dom(insertPoint).children.length, 5, 'insert point doesn\'t contain corrent number of elements');
          }

          flush(function() {
            assert.equal(eventCount, 1, 'at-form-array didn\'t fire corrent number of events');
            done();
          });
        });

        test('schema is object, data is object, set value for individual elements', function(done) {
          var formArray = document.createElement('at-form-array');

          var eventCount = 0;
          formArray.addEventListener('value-changed', function(event) {
            eventCount += 1;
          });
          formArray.value = getData();

          // internalData must have entries for each element
          assert.isObject(formArray._internalData, 'internal data is not set');
          assert.equal(Object.keys(formArray._internalData).length, 2, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray._internalData.text1, "text1 lorem ipsum", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text2, "text2 lorem ipsum", 'text2 value not correct in _internalData');
          assert.equal(formArray.value.text1, "text1 lorem ipsum", 'text1 value not correct in data');
          assert.equal(formArray.value.text2, "text2 lorem ipsum", 'text2 value not correct in data');

          assert.isArray(formArray._elementsToValidate, 'elements to validate is not set');
          assert.equal(formArray._elementsToValidate.length, 0, 'elements to validate doesn\'t contain corrent number of elements');

          var insertPoint = formArray.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1, 'insert point doesn\'t contain corrent number of elements');

          formArray.schema = schema;

          assert.isObject(formArray._internalData, 'internal data is not set');
          assert.equal(Object.keys(formArray._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray._internalData.text1, "text1 lorem ipsum", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text2, "text2 lorem ipsum", 'text2 value not correct in _internalData');
          assert.equal(formArray._internalData.text3, "text3 lorem ipsum", 'text3 value not correct in _internalData');
          assert.equal(formArray._internalData.text4, "text4 lorem ipsum", 'text4 value not correct in _internalData');

          assert.equal(formArray.value.text1, "text1 lorem ipsum", 'text1 value not correct in data');
          assert.equal(formArray.value.text2, "text2 lorem ipsum", 'text2 value not correct in data');
          assert.equal(formArray.value.text3, "text3 lorem ipsum", 'text3 value not correct in data');
          assert.equal(formArray.value.text4, "text4 lorem ipsum", 'text4 value not correct in data');

          assert.isArray(formArray._elementsToValidate, 'elements to validate is not set');
          assert.equal(formArray._elementsToValidate.length, 4, 'elements to validate doesn\'t contain corrent number of elements');
          // _elementsToValidate must have entries for each element
          assert.equal(formArray._elementsToValidate[0].id, "text1", 'text1 not present in _elementsToValidate');
          assert.equal(formArray._elementsToValidate[1].id, "text2", 'text2 not present in _elementsToValidate');
          assert.equal(formArray._elementsToValidate[2].id, "text3", 'text3 not present in _elementsToValidate');
          assert.equal(formArray._elementsToValidate[3].id, "text4", 'text4 not present in _elementsToValidate');

          var insertPoint = formArray.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 5, 'insert point doesn\'t contain corrent number of elements');

          /* these should not trigger data-changed */
          formArray.updateFormElementValue('text1', 'text1 lorem ipsum');
          formArray.updateFormElementValue('text2', 'text2 lorem ipsum');
          formArray.updateFormElementValue('text3', 'text3 lorem ipsum');
          formArray.updateFormElementValue('text4', 'text4 lorem ipsum');

          assert.isObject(formArray._internalData, 'internal data is not set');
          assert.equal(Object.keys(formArray._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray._internalData.text1, "text1 lorem ipsum", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text2, "text2 lorem ipsum", 'text2 value not correct in _internalData');
          assert.equal(formArray._internalData.text3, "text3 lorem ipsum", 'text3 value not correct in _internalData');
          assert.equal(formArray._internalData.text4, "text4 lorem ipsum", 'text4 value not correct in _internalData');

          assert.isObject(formArray.value, 'internal data is not set');
          assert.equal(Object.keys(formArray.value).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray.value.text1, "text1 lorem ipsum", 'text1 value not correct in data');
          assert.equal(formArray.value.text2, "text2 lorem ipsum", 'text2 value not correct in data');
          assert.equal(formArray.value.text3, "text3 lorem ipsum", 'text3 value not correct in data');
          assert.equal(formArray.value.text4, "text4 lorem ipsum", 'text4 value not correct in data');

          formArray.updateFormElementValue('text1', 'text1 ipsum lorem');
          formArray.updateFormElementValue('text2', 'text2 ipsum lorem');
          formArray.updateFormElementValue('text3', 'text3 ipsum lorem');
          formArray.updateFormElementValue('text4', 'text4 ipsum lorem');

          assert.isObject(formArray._internalData, 'internal data is not set');
          assert.equal(Object.keys(formArray._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray._internalData.text1, "text1 ipsum lorem", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text2, "text2 ipsum lorem", 'text2 value not correct in _internalData');
          assert.equal(formArray._internalData.text3, "text3 ipsum lorem", 'text3 value not correct in _internalData');
          assert.equal(formArray._internalData.text4, "text4 ipsum lorem", 'text4 value not correct in _internalData');

          assert.isObject(formArray.value, 'data is not set');
          assert.equal(Object.keys(formArray.value).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray.value.text1, "text1 ipsum lorem", 'text1 value not correct in data');
          assert.equal(formArray.value.text2, "text2 ipsum lorem", 'text2 value not correct in data');
          assert.equal(formArray.value.text3, "text3 ipsum lorem", 'text3 value not correct in data');
          assert.equal(formArray.value.text4, "text4 ipsum lorem", 'text4 value not correct in data');

          flush(function() {
            assert.equal(eventCount, 5, 'at-form-array didn\'t fire corrent number of events');
            done();
          });
        });

      });

      suite('schema is valid, data is valid, set values on individual elements', function() {

        var schema = {
          properties: {
            text1: {
              type: "string"
            },
            text2: {
              type: "string"
            },
            text3: {
              type: "string",
              "default": "text3 lorem ipsum"
            },
            text4: {
              type: "string",
              "default": "text4 lorem ipsum"
            }
          }
        };

        function getData1() {
          return {
            text1: "text1 lorem ipsum",
            text2: "text2 lorem ipsum",
            text3: "text3 ipsum lorem",
            text4: "text4 ipsum lorem",
          };
        }

        function getData2() {
          return {
            text1: "text1 lorem ipsum",
            text2: "text2 lorem ipsum",
          };
        }

        test('schema is object, data is object, schema first data second, set value for individual elements', function(done) {
          var formArray = document.createElement('at-form-array');

          var eventCount = 0;
          formArray.addEventListener('value-changed', function(event) {
            eventCount += 1;
          });
          formArray.schema = schema;

          // internalData must have entries for each element
          assert.isObject(formArray._internalData, 'internal data is not set');
          assert.equal(Object.keys(formArray._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray._internalData.text1, "", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text2, "", 'text2 value not correct in _internalData');
          assert.equal(formArray._internalData.text3, "text3 lorem ipsum", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text4, "text4 lorem ipsum", 'text2 value not correct in _internalData');

          assert.equal(formArray.value.text1, "", 'text1 value not correct in data');
          assert.equal(formArray.value.text2, "", 'text2 value not correct in data');
          assert.equal(formArray.value.text3, "text3 lorem ipsum", 'text1 value not correct in data');
          assert.equal(formArray.value.text4, "text4 lorem ipsum", 'text2 value not correct in data');

          assert.isArray(formArray._elementsToValidate, 'elements to validate is not set');
          assert.equal(formArray._elementsToValidate.length, 4, 'elements to validate doesn\'t contain corrent number of elements');

          var insertPoint = formArray.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 5, 'insert point doesn\'t contain corrent number of elements');

          formArray.value = getData1();

          assert.isObject(formArray._internalData, 'internal data is not set');
          assert.equal(Object.keys(formArray._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray._internalData.text1, "text1 lorem ipsum", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text2, "text2 lorem ipsum", 'text2 value not correct in _internalData');
          assert.equal(formArray._internalData.text3, "text3 ipsum lorem", 'text3 value not correct in _internalData');
          assert.equal(formArray._internalData.text4, "text4 ipsum lorem", 'text4 value not correct in _internalData');

          assert.equal(formArray.value.text1, "text1 lorem ipsum", 'text1 value not correct in data');
          assert.equal(formArray.value.text2, "text2 lorem ipsum", 'text2 value not correct in data');
          assert.equal(formArray.value.text3, "text3 ipsum lorem", 'text3 value not correct in data');
          assert.equal(formArray.value.text4, "text4 ipsum lorem", 'text4 value not correct in data');


          assert.isArray(formArray._elementsToValidate, 'elements to validate is not set');
          assert.equal(formArray._elementsToValidate.length, 4, 'elements to validate doesn\'t contain corrent number of elements');
          // _elementsToValidate must have entries for each element
          assert.equal(formArray._elementsToValidate[0].id, "text1", 'text1 not present in _elementsToValidate');
          assert.equal(formArray._elementsToValidate[1].id, "text2", 'text2 not present in _elementsToValidate');
          assert.equal(formArray._elementsToValidate[2].id, "text3", 'text3 not present in _elementsToValidate');
          assert.equal(formArray._elementsToValidate[3].id, "text4", 'text4 not present in _elementsToValidate');

          var insertPoint = formArray.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 5, 'insert point doesn\'t contain corrent number of elements');

          /* these should not trigger data-changed */
          formArray.updateFormElementValue('text1', 'text1 lorem ipsum');
          formArray.updateFormElementValue('text2', 'text2 lorem ipsum');
          formArray.updateFormElementValue('text3', 'text3 lorem ipsum');
          formArray.updateFormElementValue('text4', 'text4 lorem ipsum');

          assert.isObject(formArray._internalData, 'internal data is not set');
          assert.equal(Object.keys(formArray._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray._internalData.text1, "text1 lorem ipsum", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text2, "text2 lorem ipsum", 'text2 value not correct in _internalData');
          assert.equal(formArray._internalData.text3, "text3 lorem ipsum", 'text3 value not correct in _internalData');
          assert.equal(formArray._internalData.text4, "text4 lorem ipsum", 'text4 value not correct in _internalData');

          assert.isObject(formArray.value, 'internal data is not set');
          assert.equal(Object.keys(formArray.value).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray.value.text1, "text1 lorem ipsum", 'text1 value not correct in _internalData');
          assert.equal(formArray.value.text2, "text2 lorem ipsum", 'text2 value not correct in _internalData');
          assert.equal(formArray.value.text3, "text3 lorem ipsum", 'text3 value not correct in _internalData');
          assert.equal(formArray.value.text4, "text4 lorem ipsum", 'text4 value not correct in _internalData');

          formArray.updateFormElementValue('text1', 'text1 ipsum lorem');
          formArray.updateFormElementValue('text2', 'text2 ipsum lorem');
          formArray.updateFormElementValue('text3', 'text3 ipsum lorem');
          formArray.updateFormElementValue('text4', 'text4 ipsum lorem');

          assert.isObject(formArray._internalData, 'internal data is not set');
          assert.equal(Object.keys(formArray._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray._internalData.text1, "text1 ipsum lorem", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text2, "text2 ipsum lorem", 'text2 value not correct in _internalData');
          assert.equal(formArray._internalData.text3, "text3 ipsum lorem", 'text3 value not correct in _internalData');
          assert.equal(formArray._internalData.text4, "text4 ipsum lorem", 'text4 value not correct in _internalData');

          assert.isObject(formArray.value, 'internal data is not set');
          assert.equal(Object.keys(formArray.value).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray.value.text1, "text1 ipsum lorem", 'text1 value not correct in _internalData');
          assert.equal(formArray.value.text2, "text2 ipsum lorem", 'text2 value not correct in _internalData');
          assert.equal(formArray.value.text3, "text3 ipsum lorem", 'text3 value not correct in _internalData');
          assert.equal(formArray.value.text4, "text4 ipsum lorem", 'text4 value not correct in _internalData');

          flush(function() {
            assert.equal(eventCount, 7, 'at-form-array didn\'t fire corrent number of events');
            done();
          });
        });

        test('schema is object, data is object, data first, schema second, set value for individual elements', function(done) {
          var formArray = document.createElement('at-form-array');

          var eventCount = 0;
          formArray.addEventListener('value-changed', function(event) {
            eventCount += 1;
          });
          formArray.value = getData2();

          // internalData must have entries for each element
          assert.isObject(formArray._internalData, 'internal data is not set');
          assert.equal(Object.keys(formArray._internalData).length, 2, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray._internalData.text1, "text1 lorem ipsum", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text2, "text2 lorem ipsum", 'text2 value not correct in _internalData');

          assert.equal(formArray.value.text1, "text1 lorem ipsum", 'text1 value not correct in data');
          assert.equal(formArray.value.text2, "text2 lorem ipsum", 'text2 value not correct in data');

          assert.isArray(formArray._elementsToValidate, 'elements to validate is not set');
          assert.equal(formArray._elementsToValidate.length, 0, 'elements to validate doesn\'t contain corrent number of elements');

          var insertPoint = formArray.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1, 'insert point doesn\'t contain corrent number of elements');

          formArray.schema = schema;

          assert.isObject(formArray._internalData, 'internal data is not set');
          assert.equal(Object.keys(formArray._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray._internalData.text1, "text1 lorem ipsum", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text2, "text2 lorem ipsum", 'text2 value not correct in _internalData');
          assert.equal(formArray._internalData.text3, "text3 lorem ipsum", 'text3 value not correct in _internalData');
          assert.equal(formArray._internalData.text4, "text4 lorem ipsum", 'text4 value not correct in _internalData');

          assert.equal(formArray.value.text1, "text1 lorem ipsum", 'text1 value not correct in data');
          assert.equal(formArray.value.text2, "text2 lorem ipsum", 'text2 value not correct in data');
          assert.equal(formArray.value.text3, "text3 lorem ipsum", 'text3 value not correct in data');
          assert.equal(formArray.value.text4, "text4 lorem ipsum", 'text4 value not correct in data');

          assert.isArray(formArray._elementsToValidate, 'elements to validate is not set');
          assert.equal(formArray._elementsToValidate.length, 4, 'elements to validate doesn\'t contain corrent number of elements');
          // _elementsToValidate must have entries for each element
          assert.equal(formArray._elementsToValidate[0].id, "text1", 'text1 not present in _elementsToValidate');
          assert.equal(formArray._elementsToValidate[1].id, "text2", 'text2 not present in _elementsToValidate');
          assert.equal(formArray._elementsToValidate[2].id, "text3", 'text3 not present in _elementsToValidate');
          assert.equal(formArray._elementsToValidate[3].id, "text4", 'text4 not present in _elementsToValidate');

          var insertPoint = formArray.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 5, 'insert point doesn\'t contain corrent number of elements');

          /* these should not trigger data-changed */
          formArray.updateFormElementValue('text1', 'text1 lorem ipsum');
          formArray.updateFormElementValue('text2', 'text2 lorem ipsum');
          formArray.updateFormElementValue('text3', 'text3 lorem ipsum');
          formArray.updateFormElementValue('text4', 'text4 lorem ipsum');

          assert.isObject(formArray._internalData, 'internal data is not set');
          assert.equal(Object.keys(formArray._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray._internalData.text1, "text1 lorem ipsum", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text2, "text2 lorem ipsum", 'text2 value not correct in _internalData');
          assert.equal(formArray._internalData.text3, "text3 lorem ipsum", 'text3 value not correct in _internalData');
          assert.equal(formArray._internalData.text4, "text4 lorem ipsum", 'text4 value not correct in _internalData');

          assert.isObject(formArray.value, 'internal data is not set');
          assert.equal(Object.keys(formArray.value).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray.value.text1, "text1 lorem ipsum", 'text1 value not correct in _internalData');
          assert.equal(formArray.value.text2, "text2 lorem ipsum", 'text2 value not correct in _internalData');
          assert.equal(formArray.value.text3, "text3 lorem ipsum", 'text3 value not correct in _internalData');
          assert.equal(formArray.value.text4, "text4 lorem ipsum", 'text4 value not correct in _internalData');

          formArray.updateFormElementValue('text1', 'text1 ipsum lorem');
          formArray.updateFormElementValue('text2', 'text2 ipsum lorem');
          formArray.updateFormElementValue('text3', 'text3 ipsum lorem');
          formArray.updateFormElementValue('text4', 'text4 ipsum lorem');

          assert.isObject(formArray._internalData, 'internal data is not set');
          assert.equal(Object.keys(formArray._internalData).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray._internalData.text1, "text1 ipsum lorem", 'text1 value not correct in _internalData');
          assert.equal(formArray._internalData.text2, "text2 ipsum lorem", 'text2 value not correct in _internalData');
          assert.equal(formArray._internalData.text3, "text3 ipsum lorem", 'text3 value not correct in _internalData');
          assert.equal(formArray._internalData.text4, "text4 ipsum lorem", 'text4 value not correct in _internalData');

          assert.isObject(formArray.value, 'internal data is not set');
          assert.equal(Object.keys(formArray.value).length, 4, '_internalData doesn\'t contain correct number of properties');
          assert.equal(formArray.value.text1, "text1 ipsum lorem", 'text1 value not correct in _internalData');
          assert.equal(formArray.value.text2, "text2 ipsum lorem", 'text2 value not correct in _internalData');
          assert.equal(formArray.value.text3, "text3 ipsum lorem", 'text3 value not correct in _internalData');
          assert.equal(formArray.value.text4, "text4 ipsum lorem", 'text4 value not correct in _internalData');

          flush(function() {
            assert.equal(eventCount, 5, 'at-form-array didn\'t fire corrent number of events');
            done();
          });
        });

      });



    });
  </script>
</body>

</html>
